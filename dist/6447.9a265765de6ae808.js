"use strict";(self.webpackChunkskeleton=self.webpackChunkskeleton||[]).push([[6447],{6447:(F,E,l)=>{l.r(E),l.d(E,{PosPaiementComponent:()=>g});var p=l(177),P=l(9417),m=l(2525),e=l(4438),c=l(9192),_=l(4413),x=l(2120);const v=["receipt"];function y(a,h){1&a&&(e.j41(0,"div",30)(1,"div",31),e.EFF(2,"\u2714\ufe0e"),e.k0s(),e.j41(3,"div",32),e.EFF(4,"Paiement r\xe9ussi"),e.k0s()())}function b(a,h){if(1&a&&(e.j41(0,"div",33)(1,"div",34),e.EFF(2),e.nI1(3,"currency"),e.k0s(),e.j41(4,"div",35),e.EFF(5),e.k0s()()),2&a){const o=e.XpG();e.R7$(2),e.JRh(e.ii3(3,2,o.vente.montantTotal,"CFA ","symbol","1.0-0")),e.R7$(3),e.SpI("/ ",o.paymentMethod,"")}}function u(a,h){if(1&a&&(e.j41(0,"li",36)(1,"span",37),e.EFF(2),e.k0s(),e.j41(3,"div",38)(4,"div",39),e.EFF(5),e.k0s(),e.j41(6,"div",40),e.EFF(7),e.nI1(8,"currency"),e.k0s()(),e.j41(9,"span",41),e.EFF(10),e.nI1(11,"currency"),e.k0s()()),2&a){const o=h.$implicit;e.R7$(2),e.JRh(o.quantite),e.R7$(3),e.JRh(o.nomProduit),e.R7$(2),e.SpI("",e.ii3(8,4,o.prixUnitaire,"CFA ","symbol","1.0-0")," / Unit\xe9(s)"),e.R7$(3),e.JRh(e.ii3(11,9,o.montantLigne,"CFA ","symbol","1.0-0"))}}function k(a,h){1&a&&(e.j41(0,"li",42),e.EFF(1,"Aucun produit trouv\xe9"),e.k0s())}function n(a,h){if(1&a&&(e.j41(0,"div",24)(1,"span"),e.EFF(2,"Monnaie"),e.k0s(),e.j41(3,"span",25),e.EFF(4),e.nI1(5,"currency"),e.k0s()()),2&a){const o=e.XpG();e.R7$(4),e.JRh(e.ii3(5,1,o.changeDue,"CFA ","symbol","1.0-0"))}}function i(a,h){if(1&a&&(e.j41(0,"div",24)(1,"span"),e.EFF(2,"Reste \xe0 payer"),e.k0s(),e.j41(3,"span",25),e.EFF(4),e.nI1(5,"currency"),e.k0s()()),2&a){const o=e.XpG();e.R7$(4),e.JRh(e.ii3(5,1,o.changeDue,"CFA ","symbol","1.0-0"))}}function s(a,h){1&a&&(e.j41(0,"div",43),e.EFF(1,"Chargement du re\xe7u..."),e.k0s())}let g=(()=>{class a{constructor(o,r,t){this.router=o,this.venteService=r,this.entrepriseService=t,this.imgUrl=m.c.imgUrl,this.logo=null,this.fallbackLogo="assets/img/TCHAKEDA.png",this.vente=null,this.paymentAmount=0,this.changeDue=0,this.paymentMethod="Esp\xe8ces",this.loading=!1,this.errorMessage=null}ngOnInit(){const o=localStorage.getItem("entreprise");if(o)try{const t=JSON.parse(o);this.logo=t.logo?this.ensureAbsoluteLogoUrl(t.logo):null}catch{this.logo=null}this.logo||this.entrepriseService.getEntrepriseInfo().subscribe({next:t=>{this.logo=t.logo?this.ensureAbsoluteLogoUrl(t.logo):null;try{localStorage.setItem("entreprise",JSON.stringify(t))}catch{}},error:t=>{console.warn("Impossible de charger info entreprise pour logo",t),this.logo=null}});const r=history&&history.state?history.state:{};if(r&&r.vente)return this.vente=r.vente,this.paymentAmount=r.paymentAmount??this.vente?.montantPaye??0,this.changeDue=r.changeDue??this.paymentAmount-(this.vente?.montantTotal??0),void(this.paymentMethod=r.paymentMethod??this.vente?.modePaiement??this.paymentMethod);r&&r.venteId&&this.loadVenteById(r.venteId)}ensureAbsoluteLogoUrl(o){return o?o.startsWith("http")||o.startsWith("data:")||o.startsWith("blob:")||this.imgUrl&&o.startsWith(this.imgUrl)?o:(this.imgUrl.endsWith("/")?this.imgUrl.slice(0,-1):this.imgUrl)+(o.startsWith("/")?o:`/${o}`):this.fallbackLogo}onLogoError(){this.logo=this.fallbackLogo}loadVenteById(o){this.loading=!0,this.venteService.getVenteById(o).subscribe({next:r=>{this.vente=r,this.paymentAmount=r.montantPaye??r.montantTotal??0,this.changeDue=this.paymentAmount-(r.montantTotal??0),this.paymentMethod=r.modePaiement??this.paymentMethod,this.loading=!1},error:r=>{console.error("Erreur chargement vente",r),this.errorMessage=r?.error?.message||r?.message||"Erreur chargement vente",this.loading=!1}})}impressionReceipt(){if(!this.receiptEl)return;const o=window.location.origin;let r=this.receiptEl.nativeElement.innerHTML;r=r.replace(/src="assets\//g,`src="${o}/assets/`);const t=window.open("","_blank","left=0,top=0,width=380,height=500,toolbar=0,scrollbars=0,status=0");t?.document.write(`\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <title>Re\xe7u de paiement</title>\n        <style>\n          * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n            font-family: Arial, sans-serif;\n            -webkit-print-color-adjust: exact !important;\n            print-color-adjust: exact !important;\n          }\n          body { \n            padding: 10px; \n            background: white;\n          }\n          .paiement_right {\n            width: 100%\n            display: flex !important;\n            align-items: center !important;\n            justify-content: center;\n          }\n          .receipt {\n            width: 100% !important;\n            min-width: 350px !important; /* Largeur augment\xe9e */\n            min-height: 0 !important;\n            margin: 0 auto;\n            padding: 15px !important;\n            box-shadow: none !important;\n          }\n          .no-print { display: none !important; }\n          .paleft { padding-left: 5px !important; }\n          /* Centrage du header */\n          .receipt-header {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            text-align: center;\n            margin-bottom: 15px !important;\n          }\n          .receipt-header .logo {\n            max-width: 100px !important; /* Taille originale */\n            margin-bottom: 10px !important;\n          }\n          .ticket-info div {\n            font-size: 10px !important;\n            line-height: 1.4 !important; \n            margin-top: 4px !important; /* Espacement r\xe9duit */\n          }\n          \n          .items-list { \n            margin-bottom: 10px !important; \n            width: 100%;\n          }\n          .item .qty {\n              width: 8px !important;\n            }\n          .item {\n            display: flex !important;\n            align-items: flex-start !important;\n            margin-bottom: 8px !important;\n          }\n          .divider {\n            border-top: 1px dotted #000 !important;\n            margin: 8px 0 !important;\n          }\n          .line span {\n            font-size: 11px !important; /* Taille de police augment\xe9e */\n          }\n          \n          /* Centrage du footer */\n          .receipt-footer { \n            position: relative !important; \n            bottom: 0 !important;\n            margin-top: 20px !important;\n            font-size: 10px !important;\n            text-align: center !important;\n            width: 100%;\n          }\n          \n          .qty, .name, .total {\n            font-size: 10px !important; /* Taille de police augment\xe9e */\n          }\n          .unit-price {\n            font-size: 10px !important; /* Taille de police augment\xe9e */\n          }\n          \n          @page { \n            size: auto; \n            margin: 0; \n          }\n          @media print {\n            body { padding: 0 !important; }\n          }\n        </style>\n      </head>\n      <body>\n        ${r}\n        <div class="no-print" style="text-align:center;margin-top:20px;">\n          <button onclick="window.print()" style="padding:8px 16px;background:#1976D2;color:white;border:none;border-radius:4px;cursor:pointer;">\n            Imprimer\n          </button>\n          <button onclick="window.close()" style="padding:8px 16px;margin-left:10px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;">\n            Fermer\n          </button>\n        </div>\n        <script>\n          window.onload = function() {\n            window.print();\n            setTimeout(function() {\n              window.close();\n            }, 1000);\n          };\n        <\/script>\n      </body>\n      </html>\n    `),t?.document.close()}newOrder(){this.router.navigate(["/pos-accueil"])}modifyPayment(){this.router.navigate(["/pos-accueil"],{state:{editVente:this.vente}})}getLignes(){return this.vente?.lignes??[]}static{this.\u0275fac=function(r){return new(r||a)(e.rXU(c.Ix),e.rXU(_.W),e.rXU(x.r))}}static{this.\u0275cmp=e.VBU({type:a,selectors:[["app-pos-paiement"]],viewQuery:function(r,t){if(1&r&&e.GBs(v,5),2&r){let d;e.mGM(d=e.lsd())&&(t.receiptEl=d.first)}},decls:62,vars:34,consts:[["receipt",""],["loadingTpl",""],[1,"container_paiement"],[1,"content_paiement"],[1,"paiement_left"],[1,"content_paiement_left"],["class","card status-card",4,"ngIf","ngIfElse"],["class","card amount-card",4,"ngIf"],[1,"btn","btn-secondary",3,"click"],[1,"email-send"],["type","email","placeholder","example@gmail.com"],[1,"btn-send"],[1,"ri-send-plane-fill"],[1,"btn","btn-primary","btn-new-order",3,"click"],[1,"paiement_right"],[1,"receipt"],[1,"receipt-header"],["alt","Logo XpertPro",1,"logo",3,"error","src"],[1,"ticket-info"],[1,"items-list"],["class","item",4,"ngFor","ngForOf"],["class","no-items",4,"ngIf"],[1,"divider"],[1,"totals"],[1,"line"],[1,"paleft"],[1,"line","total-line"],[1,"payments-breakdown"],["class","line",4,"ngIf"],[1,"receipt-footer"],[1,"card","status-card"],[1,"status-icon"],[1,"status-text"],[1,"card","amount-card"],[1,"amount"],[1,"method"],[1,"item"],[1,"qty"],[1,"desc"],[1,"name"],[1,"unit-price"],[1,"total"],[1,"no-items"],[1,"loading"]],template:function(r,t){if(1&r){const d=e.RV6();e.j41(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5),e.DNE(4,y,5,0,"div",6)(5,b,6,7,"div",7),e.j41(6,"button",8),e.bIt("click",function(){return e.eBV(d),e.Njj(t.modifyPayment())}),e.EFF(7,"Modifier le paiement"),e.k0s(),e.j41(8,"button",8),e.bIt("click",function(){return e.eBV(d),e.Njj(t.impressionReceipt())}),e.EFF(9,"Imprimer le re\xe7u"),e.k0s(),e.j41(10,"div",9),e.nrm(11,"input",10),e.j41(12,"button",11),e.nrm(13,"i",12),e.k0s()(),e.j41(14,"button",13),e.bIt("click",function(){return e.eBV(d),e.Njj(t.newOrder())}),e.EFF(15,"Nouvelle commande"),e.k0s()()(),e.j41(16,"div",14)(17,"div",15,0)(19,"div",16)(20,"img",17),e.bIt("error",function(){return e.eBV(d),e.Njj(t.onLogoError())}),e.k0s(),e.j41(21,"div",18)(22,"div"),e.EFF(23),e.k0s(),e.j41(24,"div"),e.EFF(25),e.nI1(26,"date"),e.k0s(),e.j41(27,"div"),e.EFF(28),e.k0s(),e.j41(29,"div"),e.EFF(30),e.k0s()()(),e.j41(31,"ul",19),e.DNE(32,u,12,14,"li",20)(33,k,2,0,"li",21),e.k0s(),e.nrm(34,"div",22),e.j41(35,"div",23)(36,"div",24)(37,"span"),e.EFF(38,"Sous-total"),e.k0s(),e.j41(39,"span",25),e.EFF(40),e.nI1(41,"currency"),e.k0s()(),e.j41(42,"div",26)(43,"span"),e.EFF(44,"Total"),e.k0s(),e.j41(45,"span",25),e.EFF(46),e.nI1(47,"currency"),e.k0s()()(),e.nrm(48,"div",22),e.j41(49,"div",27)(50,"div",24)(51,"span"),e.EFF(52),e.k0s(),e.j41(53,"span",25),e.EFF(54),e.nI1(55,"currency"),e.k0s()(),e.DNE(56,n,6,6,"div",28)(57,i,6,6,"div",28),e.k0s(),e.j41(58,"div",29),e.EFF(59," G\xe9n\xe9r\xe9 par Tchakeda "),e.k0s()(),e.DNE(60,s,2,0,"ng-template",null,1,e.C5r),e.k0s()()()}if(2&r){let d,f,M,C,O;const T=e.sdS(61);e.R7$(4),e.Y8G("ngIf",t.vente)("ngIfElse",T),e.R7$(),e.Y8G("ngIf",t.vente),e.R7$(15),e.Y8G("src",t.logo||"assets/img/TCHAKEDA.png",e.B4B),e.R7$(3),e.SpI("Ticket : ",null!==(d=null==t.vente?null:t.vente.venteId)&&void 0!==d?d:"\u2014",""),e.R7$(2),e.JRh(e.i5U(26,16,null==t.vente?null:t.vente.dateVente,"dd/MM/yyyy HH:mm")),e.R7$(3),e.SpI("Servi par : ",null!==(f=null==t.vente?null:t.vente.nomVendeur)&&void 0!==f?f:"\u2014",""),e.R7$(2),e.SpI("Boutique : ",null!==(M=null==t.vente?null:t.vente.nomBoutique)&&void 0!==M?M:"\u2014",""),e.R7$(2),e.Y8G("ngForOf",t.getLignes()),e.R7$(),e.Y8G("ngIf",0===t.getLignes().length),e.R7$(7),e.JRh(e.ii3(41,19,null==t.vente?null:t.vente.montantTotal,"CFA ","symbol","1.0-0")),e.R7$(6),e.JRh(e.ii3(47,24,null==t.vente?null:t.vente.montantTotal,"CFA ","symbol","1.0-0")),e.R7$(6),e.JRh(t.paymentMethod),e.R7$(2),e.JRh(e.ii3(55,29,t.paymentAmount,"CFA ","symbol","1.0-0")),e.R7$(2),e.Y8G("ngIf",t.paymentAmount>=(null!==(C=null==t.vente?null:t.vente.montantTotal)&&void 0!==C?C:0)),e.R7$(),e.Y8G("ngIf",t.paymentAmount<(null!==(O=null==t.vente?null:t.vente.montantTotal)&&void 0!==O?O:0))}},dependencies:[P.YN,p.MD,p.Sq,p.bT,p.oe,p.vh,P.X1],styles:[".container_paiement[_ngcontent-%COMP%]{width:100%}.content_paiement[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;height:100vh;background:#fff}.paiement_left[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;justify-content:center}.content_paiement_left[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:stretch;gap:15px;width:60%;position:relative;top:-10%}.card[_ngcontent-%COMP%]{border:1px solid #A5D6A7;border-radius:4px;padding:16px;display:flex;align-items:center;flex-direction:row}.status-card[_ngcontent-%COMP%]{background:#e8f5e9;margin-bottom:0;padding:30px 20px}.status-icon[_ngcontent-%COMP%]{width:24px;height:24px;background:#4caf50;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:16px}.status-text[_ngcontent-%COMP%]{font-size:16px;font-weight:500;color:#2e7d32}.amount-card[_ngcontent-%COMP%]{justify-content:space-between;margin-bottom:0}.amount[_ngcontent-%COMP%], .method[_ngcontent-%COMP%]{font-size:18px;color:#2e7d32}.btn[_ngcontent-%COMP%]{padding:14px 20px;border:none;border-radius:4px;font-size:16px;cursor:pointer}.btn-secondary[_ngcontent-%COMP%]{background:#f9f9f9;color:#333}.email-send[_ngcontent-%COMP%]{display:flex;align-items:center;border:1px solid #ddd;border-radius:4px;overflow:hidden;position:relative}.email-send[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1;border:none;padding:12px;font-size:14px}.email-send[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none}.btn-send[_ngcontent-%COMP%]{background:#1976d2;color:#fff;font-size:20px;border:none;border-radius:4px 0 0 4px;padding:8px 22px}.btn-primary[_ngcontent-%COMP%]{background:#1976d2;color:#fff}.btn-new-order[_ngcontent-%COMP%]{margin-top:auto}.paiement_right[_ngcontent-%COMP%]{padding:40px;background:#ececec;overflow-y:auto;margin-bottom:8%}.receipt[_ngcontent-%COMP%]{max-width:350px;min-height:80vh;margin:0 auto;background:#fff;padding:24px 15px;box-shadow:0 2px 6px #0000001a;position:relative}.receipt-header[_ngcontent-%COMP%]{text-align:center;margin-bottom:15px}.receipt-header[_ngcontent-%COMP%]   .logo[_ngcontent-%COMP%]{max-width:130px}.ticket-info[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{font-size:12px;color:#555;line-height:2px;margin-top:20px}.items-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0 0 16px}.item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;margin-bottom:12px}.item[_ngcontent-%COMP%]   .qty[_ngcontent-%COMP%]{width:14px;font-weight:700;font-size:12px}.desc[_ngcontent-%COMP%]{flex:1;margin:0 12px}.name[_ngcontent-%COMP%]{font-weight:500;font-size:13px}.unit-price[_ngcontent-%COMP%]{font-size:10px;color:#777}.total[_ngcontent-%COMP%]{white-space:nowrap;font-size:13px}.divider[_ngcontent-%COMP%]{border-top:1px dotted #bbb;margin:12px 0}.totals[_ngcontent-%COMP%]   .line[_ngcontent-%COMP%], .payments-breakdown[_ngcontent-%COMP%]   .line[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px}.total-line[_ngcontent-%COMP%]{font-weight:600}.receipt-footer[_ngcontent-%COMP%]{position:absolute;bottom:10px;left:0;width:100%;font-size:8px;color:#888;text-align:center;font-style:italic}"]})}}return a})()},2120:(F,E,l)=>{l.d(E,{r:()=>b});var p=l(1626),P=l(4412),m=l(5558),e=l(9437),c=l(8810),_=l(8141),x=l(2525),v=l(4438),y=l(8026);let b=(()=>{class u{constructor(n,i){this.http=n,this.usersService=i,this.apiUrl=x.c.apiBaseUrl,this.entrepriseSubject=new P.t([]),this.entreprise$=this.entrepriseSubject.asObservable()}getListEntreprises(){return this.usersService.getValidAccessToken().pipe((0,m.n)(n=>{const i=new p.Lr({Authorization:`Bearer ${n}`,"Content-Type":"application/json"});return this.http.get(`${this.apiUrl}/entreprises`,{headers:i})}),(0,e.W)(n=>{let i="Erreur inconnue";return n.error instanceof ErrorEvent?i=`Erreur: ${n.error.message}`:404===n.status&&(i="Aucune entreprise trouv\xe9e"),(0,c.$)(()=>new Error(i))}))}addEntreprise(n){return this.usersService.getValidAccessToken().pipe((0,m.n)(i=>{const s=new p.Lr({Authorization:`Bearer ${i}`,"Content-Type":"application/json"});return this.http.post(`${this.apiUrl}/entreprise-clients`,n,{headers:s})}),(0,_.M)(i=>{this.entrepriseSubject.next([...this.entrepriseSubject.value,i])}),(0,e.W)(i=>{let s="Erreur inconnue";return i.error instanceof ErrorEvent?s=`Erreur: ${i.error.message}`:400===i.status&&(s=i.error||"Donn\xe9es invalides"),(0,c.$)(()=>new Error(s))}))}getListEntreprise(){return this.usersService.getValidAccessToken().pipe((0,m.n)(n=>{if(!n)return console.error("Token vide ou non d\xe9fini ! V\xe9rifiez que l'utilisateur est bien connect\xe9."),(0,c.$)(()=>new Error("Token manquant"));const i=(new p.Lr).set("Authorization",`Bearer ${n}`);return console.log("En-t\xeates envoy\xe9s : ",i),this.http.get(`${this.apiUrl}/entreprises`,{headers:i})}),(0,_.M)(n=>{this.entrepriseSubject.next(n)}),(0,e.W)(n=>(console.error("Erreur lors de la r\xe9cup\xe9ration des entreprises:",n),(0,c.$)(()=>n))))}getEntrepriseById(n){return this.usersService.getValidAccessToken().pipe((0,m.n)(i=>{if(!i)return console.error("Token manquant"),(0,c.$)(()=>new Error("Token manquant"));const s=new p.Lr({Authorization:`Bearer ${i}`,"Content-Type":"application/json"});return this.http.get(`${this.apiUrl}/entreprises/${n}`,{headers:s})}),(0,e.W)(i=>{let s="Erreur inconnue";return i.error instanceof ErrorEvent?s=`Erreur: ${i.error.message}`:404===i.status&&(s="Entreprise non trouv\xe9e"),(0,c.$)(()=>new Error(s))}))}updateEntreprise(n,i){return this.usersService.getValidAccessToken().pipe((0,m.n)(s=>{if(!s)return(0,c.$)(()=>new Error("Token manquant"));const g=new p.Lr({Authorization:`Bearer ${s}`});return this.http.patch(`${this.apiUrl}/updateEntreprise/${n}`,i,{headers:g,responseType:"text"})}),(0,e.W)(s=>{let g="Erreur inconnue";return s.error instanceof ErrorEvent?g=`Erreur: ${s.error.message}`:400===s.status&&(g=s.error||"Donn\xe9es invalides"),(0,c.$)(()=>new Error(g))}))}getEntrepriseInfo(){return this.usersService.getValidAccessToken().pipe((0,m.n)(n=>{if(!n)return(0,c.$)(()=>new Error("Aucun token trouv\xe9"));const i=new p.Lr({Authorization:`Bearer ${n}`});return this.http.get(`${this.apiUrl}/myEntreprise`,{headers:i}).pipe((0,_.M)(s=>{localStorage.setItem("entreprise",JSON.stringify(s))}))}),(0,e.W)(n=>(console.error("Erreur r\xe9cup\xe9ration info entreprise:",n),(0,c.$)(()=>n))))}decodeJwt(n){return JSON.parse(atob(n.split(".")[1]))}isTokenExpired(n){return new Date(1e3*n.exp)<new Date}getNewTokenFromApi(){const n=localStorage.getItem("refreshToken");return this.http.post(`${this.apiUrl}/refresh-token`,{refreshToken:n})}static{this.\u0275fac=function(i){return new(i||u)(v.KVO(p.Qq),v.KVO(y.g))}}static{this.\u0275prov=v.jDH({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})()}}]);