  <!-- Message d'erreur principal -->
   <div class="toast-container">
        <div *ngIf="errorMessageApi" class="alert alert-danger toast-message-danger">
          {{ errorMessageApi }}
        </div>
        
        <!-- Message de succès -->
        <div *ngIf="successMessage" class="alert alert-success toast-message-success">
          {{ successMessage }}
        </div>
    </div>
  
<div class="containerTable">
  <!-- En-tête : titre, actions et barre de recherche -->
  <div class="tasks-header">
    <h1 class="title">Produits / Services</h1>

    <div class="actions">
      <button class="add-task" (click)="goToAddProduit()">Ajouter un produit</button>
       <button class="add-task1" (click)="openExcelImportModal()" title="importer Excel">
       <i class="fa fa-download" aria-hidden="true"></i>
      </button>
      
 
       <div class="bare"></div>

      <div class="contentIcon">
        <i class="ri-refresh-line" (click)="rafraichirProduits()" *ngIf="!isLoading"></i>
        <i *ngIf="isLoading" class="ri-loader-line ri-spin"></i>
        <div class="bare"></div>

        <div class="export-container" #popupContainer> 

            <i (click)="togglePopup()">
              <img src="assets/icon/category.png" alt="Category Icon" style="width: 20px; height: 20px;" />
            </i>
              <!-- Popup -->
          <div *ngIf="isPopupVisible" class="popup show">
            <div class="checkbox-list">
             <label *ngFor="let cat of categories">
                 <input type="checkbox" [(ngModel)]="cat.selected" (change)="onCheckboxChange()" />
                {{ cat.nom }}
              </label>
            </div>

            <!-- Si au moins une case est cochée, afficher les boutons -->
            <div *ngIf="isAnySelected" class="action-buttons">
              <button class="cancel-btn" (click)="cancelSelection()">Annuler</button>
              <button class="delete-btn" (click)="deleteSelection()">Supprimer</button>
            </div>
          </div>
        </div>

        <div class="bare"></div>
        <div class="export-container">
          <div class="iconDrop">
            <i class="ri-printer-cloud-line" (click)="toggleExportDropdown()"></i>
          </div>
          <div class="export-dropdown" *ngIf="showExportDropdown">
            <div class="export-option" (click)="downloadExcel()">Télécharger en Excel</div>
            <div class="export-option" (click)="downloadPDF()">Télécharger en PDF</div>
            <div class="export-option" (click)="downloadCSV()">Télécharger en CSV</div>
          </div>
        </div>
        
      </div>

    <!-- Nouvelle barre de recherche avec filtres -->
    <div class="container_inputSearch" style="display: flex; align-items: center; position: relative;">
      <div class="inputSearch" style="flex: 1; position: relative;">
        <div class="tags-container" 
          (click)="focusSearchInput()"
          style="display: flex; flex-wrap: wrap; align-items: center; padding-left: 35px; min-height: 40px; border: 1.5px solid #000; border-top-left-radius: 5px; min-width: 250px; border-bottom-left-radius: 5px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; background: white; cursor: text;">   
          
          <span *ngIf="selectedFilters.length > 0" class="tag" style="display: flex; align-items: center; background: #e0e0e0; padding: 2px 8px; border-radius: 20px; margin: 2px 4px 2px 0; font-size: 12px; z-index: 12;">
            {{ selectedFilters[0].label }}
            <span class="remove-chip" (click)="removeFilter(selectedFilters[0]); $event.stopPropagation()">✖</span>
          </span>

          <input 
            #searchInput
            type="text" 
            [(ngModel)]="searchText" 
            (ngModelChange)="applyFilters()" 
            [placeholder]="getSearchPlaceholder()"
            style="border: none; outline: none; flex: 1; padding: 5px 0; min-width: 120px;"
            (click)="$event.stopPropagation()"
          />

          <i class="ri-search-2-line" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
        </div>
      </div>

      <div class="trier" title="Trier et filtrer" (click)="toggleFilterDropdown(); $event.stopPropagation()" style="cursor: pointer;">
        <i *ngIf="!showFilterDropdown" style="font-size: 18px;" class="ri-arrow-down-s-fill"></i>
        <i *ngIf="showFilterDropdown" style="font-size: 18px;" class="ri-close-line"></i>
      </div>

      <div class="filter-dropdown" *ngIf="showFilterDropdown" (click)="$event.stopPropagation()"
          style="position: absolute; top: 100%; right: 0; background: white; 
          border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
          z-index: 100; width: 100%; margin-top: 5px;">
        <div class="filter-section" style="padding: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
              <h4 style="margin: 0; font-size: 16px; color: #333;">Filtres</h4>
              <div>
                <button (click)="resetFilters(); $event.stopPropagation()" 
                        style="background: none; border: none; color: #0671e4; cursor: pointer; font-size: 13px;">
                  Réinitialiser
                </button>
              </div>
          </div>
          <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
            <li (click)="addFilter({ type: 'nomCategorie', label: 'Catégorie' })" 
                [class.disabled]="isFilterSelected('nomCategorie')"
                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; transition: background 0.3s;"
                [style.background]="isFilterSelected('nomCategorie') ? '#f0f0f0' : 'transparent'">
              Catégorie
            </li>
            <li (click)="addFilter({ type: 'nomUnite', label: 'Unité' })" 
                [class.disabled]="isFilterSelected('nomUnite')"
                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: background 0.3s;"
                [style.background]="isFilterSelected('nomUnite') ? '#f0f0f0' : 'transparent'">
              Unité
            </li>
          </ul>
        </div>
      </div>
    </div>
      
    </div>
  </div>

<div class="container_list_boutique" cdkDropList 
  [cdkDropListData]="boutiques" 
  (cdkDropListDropped)="onDrop($event)"
  cdkDropListAutoScroll>
    <div class="content_list_boutique">
        <div class="name_boutique">
            <div class="all_boutique" 
                [class.name_boutique_active]="selectedBoutique === null"
                (click)="selectBoutique(null)">
                <p class="all_boutique" style="display: flex; align-items: center;">
                  Toutes les boutiques
                  <span *ngIf="!isLoadingCounts && totalAllProducts > 0" class="facture-count">
                    {{ totalAllProducts }}
                  </span>
                  <span *ngIf="isLoadingCounts" class="facture-count">
                    <i class="ri-loader-line ri-spin" style="font-size: 12px;"></i>
                  </span>
                </p>
            </div>
        
            <ng-container *ngIf="(boutiques?.length || 0) > 0;">
                <!-- <ng-container *ngFor="let boutique of boutiques || []; let i = index"> -->
                  <ng-container *ngFor="let boutique of boutiquesSansEntrepots; let i = index">
                    <div cdkDrag class="draggable-item" [class.name_boutique_active]="boutique.id === selectedBoutique?.id && boutique.actif"
                        [class.suspended-boutique]="!boutique.actif"
                        [style.color]="boutique.actif"
                        (click)="boutique.actif ? selectBoutique(boutique) : showSuspendedBoutiqueDialog()">
                        <p style="display: flex; align-items: center;">
                          {{ boutique.nomBoutique }}
                          <span *ngIf="productCounts[boutique.id] > 0" class="facture-count">
                            {{ productCounts[boutique.id] }}
                          </span>
                          <i *ngIf="!boutique.actif" class="ri-error-warning-line warning-icon"></i>
                        </p>
                    </div>
                    <div *ngIf="i !== boutiques.length - 1" class="barre"></div>
                </ng-container>
            </ng-container>

            <!-- <ng-template #noBoutiques>
                <p class="no-boutiques-message">Aucune boutique trouvée</p>
            </ng-template> -->
        </div>
    </div>
</div>


  <!-- Tableau des produits -->
  <table>
    <thead>
      <tr class="titleTableProduit">
        <th>Code</th>
        <th>Photo</th>
        <th>Nom produit</th>
        <th>Description</th>
        <th>Catégorie</th>
        <th>Prix Vente</th>
        <th>Coût du produit</th>
        <!-- <th style="background-color: #0671e44a;">En stock</th> -->
        <th>Unité</th>
        <th>Type</th>
        <ng-container *ngIf="!selectedBoutique">
          <th>Boutique</th>
        </ng-container>
      </tr>
    </thead>
    <tbody>
      <!--  -->
      <tr *ngFor="let product of filteredProducts(); let i = index" style="font-size: 10px;" (click)="openProduitDetail(product.id)">
        <td [innerHTML]="highlightMatch(product.codeGenerique || '')"></td>
        <td>
          <div class="imgProduit">
            <img [src]="product.photo" alt="Produit">
          </div>
          <div class="modal" *ngIf="imagePopup">
            <div class="modal-content" (click)="$event.stopPropagation()">
              <img [src]="imagePopup" alt="Produit">
            </div>
          </div>
        </td>
        <!-- <div> {{ product | json }}</div> -->
        <td [innerHTML]="highlightMatch(product.nom)" ></td>
        <td class="description-cell" (mouseover)="showDescription = true" (mouseout)="showDescription = false">
          {{ product.description ? (product.description | slice:0:20) + (product.description.length > 20 ? '...' : '') : 'sans description' }}
          <div class="description-hover" *ngIf="showDescription">{{ product.description || 'sans description' }}</div>
        </td>
        <td [innerHTML]="highlightMatch(product.nomCategorie || 'sans categorie')"></td>
        <td>{{ product.prixVente | customNumber }}</td>
        <td>{{ product.prixAchat | customNumber }}</td>
        <!-- <td style="background-color: #0671e410;" [innerHTML]="highlightMatch(product.quantite.toString())"></td> -->
        <!-- <td>{{ product.nomUnite || 'Sans unité'}}</td> -->
        <td [innerHTML]="highlightMatch(product.nomUnite || 'sans unite')"></td>
       <td>
          {{ product.typeProduit === 'PHYSIQUE' ? 'Produit' : (product.typeProduit === 'SERVICE' ? 'Service' : 'Type Produit') }}
        </td>

        <!-- <td>
          <span *ngIf="product.boutiques && product.boutiques.length > 0">
            {{ product.boutiques.map(b => b.nom).join(', ') }}
          </span>
          <span *ngIf="!product.boutiques || product.boutiques.length === 0">
            Aucune boutique
          </span>
        </td> -->
        <!-- Cellule conditionnelle -->
        <ng-container>
          <td  *ngIf="!selectedBoutique">{{ getBoutiqueNames(product.boutiques) }}</td>
        </ng-container>
      </tr>
      <!-- Message si aucun produit ne correspond à la recherche -->
      <tr *ngIf="tasks.length > 0 && filteredProducts().length === 0">
        <td colspan="10" style="text-align: center;">Aucun produit trouvée.</td>
      </tr>
    </tbody>
  </table>

  <!-- Message si aucun produit n'est présent -->
  <div *ngIf="showNoProductsMessage && !isLoading" style="text-align: center; margin-top: 20px;">
    <p style="color: red;">Vous n'avez pas de produit</p>
  </div>

  <!-- Pagination personnalisée -->
  <div class="pager" aria-label="Pagination" *ngIf="totalElements > pageSize">
    <div class="pager-info">
      <span>Produits par page:</span>
      <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
      <span class="page-info">{{ getPageInfo() }}</span>
    </div>
    
    <div class="pager-navigation">
      <button 
        class="pager-btn" 
        [disabled]="currentPage === 0"
        (click)="goToPage(0)"
        title="Première page">
        <i class="ri-skip-back-line"></i>
      </button>
      
      <button 
        class="pager-btn" 
        [disabled]="currentPage === 0"
        (click)="goToPage(currentPage - 1)"
        title="Page précédente">
        <i class="ri-arrow-left-s-line"></i>
      </button>
      
              <div class="page-numbers">
          <button 
            *ngFor="let page of getVisiblePages()" 
            class="page-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
            [disabled]="page === '...'">
            {{ page }}
          </button>
        </div>
      
      <button 
        class="pager-btn" 
        [disabled]="currentPage >= totalPages - 1"
        (click)="goToPage(currentPage + 1)"
        title="Page suivante">
        <i class="ri-arrow-right-s-line"></i>
      </button>
      
      <button 
        class="pager-btn" 
        [disabled]="currentPage >= totalPages - 1"
        (click)="goToPage(totalPages - 1)"
        title="Dernière page">
        <i class="ri-skip-forward-line"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal d'importation Excel -->
<div class="modal" *ngIf="showExcelImportModal">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closeExcelImportModal()">&times;</span>
    
    <h5>Importer des produits depuis Excel</h5>

    <div class="container_modal_excel">

      <div class="import-instructions">
        <h3>Instructions pour préparer votre fichier Excel :</h3>
        <ol>
          <li style="font-size: 12px;">Téléchargez notre modèle Excel ci-dessous</li>
          <li style="font-size: 12px;">Remplissez les colonnes avec vos données</li>
          <li style="font-size: 12px;">Les colonnes obligatoires sont marquées d'un *</li>
          <li style="font-size: 12px;">Évitez de modifier les en-têtes de colonnes</li>
        </ol>
        
        <div class="columns-info">
          <h6>Structure des colonnes :</h6>
          <ul>
            <li><strong>Nom produit <span style="color: red;">*</span></strong> - Nom du produit (texte)</li>
            <li><strong>Description</strong> - Description du produit</li>
            <li><strong>Catégorie <span style="color: red;">*</span></strong> - Nom de la catégorie existante</li>
            <li><strong>Prix Vente <span style="color: red;">*</span></strong> - Prix de vente (nombre)</li>
            <li><strong>Prix Achat <span style="color: red;">*</span></strong> - Prix d'achat (nombre)</li>
            <li><strong>Quantité <span style="color: red;">*</span></strong> - Quantité initiale (nombre entier)</li>
            <li><strong>Unité</strong> - Unité de mesure existante</li>
            <li><strong>Code Barre</strong> - Code barre (nombre entier)</li>
            <li><strong>Type Produit</strong> - PHYSIQUE ou SERVICE</li>
            <!-- <li><strong>Date Preemption</strong> - Date de préemption (format: JJ-MM-AAAA)</li> -->
             <li>
                <strong>Date Preemption</strong> - Format: <span style="color:red;font-weight:bold">dd-MM-yyyy</span> 
                (ex: 31-12-2025)
              </li>
            <li><strong>Seuil Alert</strong> - Seuil d'alerte stock (nombre entier)</li>
          </ul>
        </div>
        
        <button class="download-template" (click)="downloadExcelTemplate()">
          <i class="ri-download-line"></i> Télécharger le modèle
        </button>
      </div>

      <div class="left_import_excel">
        <div class="double_input2">
          <div class="champ_input" [class.invalid-field]="showBoutiqueError">
            <input autocomplete="off" 
                  type="text" 
                  placeholder="Sélectionner vos boutiques"
                  class="input_focus" 
                  matInput 
                  (click)="toggleBoutiqueSelectionPanel()"
                  [value]="getSelectedBoutiquesText()"
                  readonly
                  style="cursor: pointer;">
            <label for="boutiqueId" class="label"><i class="ri-check-double-line"></i> Sélectionner vos boutiques</label>
            
            <div class="boutique-selection-panel" *ngIf="showBoutiqueSelectionPanel">
              <div class="panel-header">
                <h4>Sélectionner des boutiques</h4>
                <button class="close-btn" (click)="toggleBoutiqueSelectionPanel()">&times;</button>
              </div>
              <div class="panel-body">
                <div class="boutique-item select-all">
                  <label>
                    <input type="checkbox" 
                          [checked]="areAllBoutiquesSelected()"
                          (change)="toggleSelectAllBoutiques($event)">
                    Sélectionner toutes les boutiques
                  </label>
                </div>
                
                <div *ngFor="let boutique of boutiques" class="boutique-item">
                  <label>
                    <input type="checkbox" 
                          [checked]="selectedBoutiquesForImport.includes(boutique.id)"
                          (change)="toggleBoutiqueSelection(boutique.id)">
                    {{ boutique.nomBoutique }}
                  </label>
                </div>
              </div>
              <div class="panel-footer">
                <button class="btn-confirm" (click)="confirmBoutiqueSelection()">Confirmer</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="file-upload-area" (click)="fileInput.click()" [class.active]="selectedFile">
          <input type="file" #fileInput (change)="onFileSelected($event)" accept=".xlsx, .xls" hidden>
          <i class="ri-upload-cloud-2-line"></i>
          <p *ngIf="!selectedFile">Cliquez pour sélectionner votre fichier Excel</p>
          <p *ngIf="selectedFile">{{ selectedFile.name }}</p>
          <small>Formats acceptés: .xlsx, .xls (Max 5MB)</small>
        </div>
        
        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeExcelImportModal()">Annuler</button>
          <button class="btn-import" 
                  (click)="uploadExcel()" 
                  [disabled]="!selectedFile">
            
            <!-- Remplacer le texte par un spinner -->
            <ng-container>Importer</ng-container>
            <!-- <i *ngIf="isImporting" class="ri-loader-4-line ri-spin"></i> -->
          </button>
        </div>
        
        <div *ngIf="importMessage" class="import-status" [class.success]="importSuccess" [class.error]="!importSuccess">
          {{ importMessage }}
          <div *ngIf="importErrors.length > 0" class="import-errors">
            <h4>Erreurs survenues :</h4>
            <ul>
              <li *ngFor="let error of importErrors">{{ error }}</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
    

  </div>
</div>