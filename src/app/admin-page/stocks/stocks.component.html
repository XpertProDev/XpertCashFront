<div class="containerTable">
  <!-- En-tête : titre, actions et barre de recherche -->
  <div class="tasks-header">
    <h1 class="title">Mes Stocks</h1>
    <div class="actions">
      <button class="add-task" routerLink="/stock_ajustement" >Créer un ajustement de stock</button>
      <div class="contentIcon">
        <i class="ri-refresh-line"></i>
        <div class="bare"></div>
        <div class="export-container">
          <div class="iconDrop">
            <i class="ri-printer-cloud-line" (click)="toggleExportDropdown()"></i>
          </div>
          <div class="export-dropdown" *ngIf="showExportDropdown">
            <div class="export-option" (click)="downloadExcel()">Télécharger en Excel</div>
            <div class="export-option" (click)="downloadPDF()">Télécharger en PDF</div>
            <div class="export-option" (click)="downloadCSV()">Télécharger en CSV</div>
          </div>
        </div>
      </div>

      <!-- Remplacez la partie .container_inputSearch par ce code -->
      <div class="container_inputSearch" style="display: flex; align-items: center; position: relative;">
        <!-- Barre de recherche avec tags -->
        <div class="inputSearch" style="flex: 1; position: relative;">
          <div class="tags-container" 
            (click)="focusSearchInput()"
            style="display: flex; flex-wrap: wrap; align-items: center; padding-left: 35px; min-height: 40px; border: 1.5px solid #000; border-top-left-radius: 5px; min-width: 250px; border-bottom-left-radius: 5px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; background: white; cursor: text;">   

            <!-- Tags pour les filtres sélectionnés -->
            <!-- <span *ngFor="let filter of selectedFilters" class="tag" style="display: flex; align-items: center; background: #e0e0e0; padding: 2px 8px; border-radius: 20px; margin: 2px 4px 2px 0;">
              {{ filter.label }}
              <span class="remove-chip" (click)="removeFilter(filter)">✖</span>
            </span> -->
            <!-- Remplacer la boucle *ngFor par -->
            <span *ngIf="selectedFilters.length > 0" class="tag" style="display: flex; align-items: center; background: #e0e0e0; padding: 2px 8px; border-radius: 20px; margin: 2px 4px 2px 0; z-index: 12;">
              {{ selectedFilters[0].label }}
              <span class="remove-chip" (click)="removeFilter(selectedFilters[0])">✖</span>
            </span>

              <!-- <span *ngIf="selectedFilters.length > 0" 
                    class="reset-filter" 
                    (click)="resetFilters()"
                    style="margin-left: 5px; cursor: pointer; color: #0671e4;">
                Réinitialiser
              </span> -->
              <!-- <i class="ri-close-line" (click)="removeFilter(filter)" style="margin-left: 5px; cursor: pointer;"></i> -->

            <input 
              #searchInput
              type="text" 
              [(ngModel)]="searchText" 
              (ngModelChange)="applyFilters()" 
              [placeholder]="getSearchPlaceholder()"
              style="border: none; outline: none; flex: 1; padding: 5px 0; min-width: 120px;"
              (click)="$event.stopPropagation()"
            />

            <i class="ri-search-2-line" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
          </div>
        </div>

        <!-- Bouton de tri -->
        <div class="trier" title="Trier et filtrer" (click)="toggleFilterDropdown(); $event.stopPropagation()" style="cursor: pointer;">
          <i *ngIf="!showFilterDropdown" style="font-size: 18px;" class="ri-arrow-down-s-fill"></i>
          <i *ngIf="showFilterDropdown" style="font-size: 18px;" class="ri-close-line"></i>
        </div>

        <!-- Dropdown de filtres -->
      <div class="filter-dropdown" *ngIf="showFilterDropdown" (click)="$event.stopPropagation()"
          style="position: absolute; top: 100%; right: 0; background: white; 
          border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
          z-index: 100; width: 100%; margin-top: 5px;"> <!--width: 250px;-->
        <div class="filter-section" style="padding: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
              <h4 style="margin: 0; font-size: 16px; color: #333;">Filtres</h4>
              <div>
                <button (click)="resetFilters(); $event.stopPropagation()" 
                        style="background: none; border: none; color: #0671e4; cursor: pointer; font-size: 13px;">
                  Réinitialiser
                </button>
                <!-- <i class="ri-close-line" (click)="showFilterDropdown = false; $event.stopPropagation()" 
                  style="cursor: pointer; font-size: 18px;"></i> -->
              </div>
          </div>
          <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
            <li (click)="addFilter({ type: 'nomCategorie', label: 'Catégorie' })" 
                [class.disabled]="isFilterSelected('nomCategorie')"
                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; transition: background 0.3s;"
                [style.background]="isFilterSelected('nomCategorie') ? '#f0f0f0' : 'transparent'">
              Catégorie
            </li>
            <li (click)="addFilter({ type: 'nomUnite', label: 'Unité' })" 
                [class.disabled]="isFilterSelected('nomUnite')"
                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: background 0.3s;"
                [style.background]="isFilterSelected('nomUnite') ? '#f0f0f0' : 'transparent'">
              Unité
            </li>
          </ul>
        </div>
      </div>

      </div>

    </div>
  </div>

  <div class="container_list_boutique">
    <div class="content_list_boutique">
      <div class="name_boutique">
        <ng-container *ngIf="(boutiques?.length || 0) > 0; else noBoutiques">
          <!-- Option "Toutes les boutiques" -->
          <div class="all_boutique" 
               [class.name_boutique_active]="selectedBoutique === null"
               (click)="selectBoutique(null)">
            <!-- <p class="all_boutique">Toutes les boutiques</p> -->
             <p class="all_boutique" style="display: flex; align-items: center;">
                Toutes les boutiques
                <span *ngIf="totalAllProducts > 0" class="facture-count">
                  {{ totalAllProducts }}
                </span>
              </p>
          </div>
          
          <!-- Liste des boutiques -->
          <ng-container *ngFor="let boutique of boutiques; let i = index">
              <p 
              [class.name_boutique_active]="boutique.id === selectedBoutique?.id && boutique.actif"
              [class.suspended-boutique]="!boutique.actif"
              [style.color]="boutique.actif"
              (click)="boutique.actif ? selectBoutique(boutique) : showSuspendedBoutiqueDialog()"
              style="display: flex; align-items: center;">
              {{ boutique.nomBoutique }}
              <span *ngIf="productCounts[boutique.id] > 0" class="facture-count">
                {{ productCounts[boutique.id] }}
              </span>
              <i *ngIf="!boutique.actif" class="ri-error-warning-line warning-icon"></i>
            </p>
            <div *ngIf="i !== boutiques.length - 1" class="barre"></div>
          </ng-container>
        </ng-container>
        <ng-template #noBoutiques>
          <p class="no-boutiques-message">Aucune boutique trouvée</p>
        </ng-template>
      </div>
    </div>
  </div>
  

  <!-- Tableau des produits -->
  <table>
    <thead>
      <tr class="titleTableProduit">
        <th (click)="setSorting('codeGenerique')">
          Code
          <i *ngIf="sortColumn === 'codeGenerique'" 
            class="{{ sortDirection === 'asc' ? 'ri-arrow-up-line' : 'ri-arrow-down-line' }}"></i>
        </th>
        <th>Photo</th>
        <th>Nom produit</th>
        <!-- <th>Description</th> -->
        <th>Catégorie</th>
        <th>Prix Vente</th>
        <th>Coût du produit</th>
        <th style="background-color: #0671e44a;">En stock</th>
        <th>Unité</th>
        <th>Seuil Alerte</th>
        <ng-container *ngIf="!selectedBoutique">
          <th>Boutique</th>
        </ng-container>
      </tr>
    </thead>
    <tbody>
      <!-- Boucle sur la liste filtrée et paginée -->
      <!-- (click)="openStockDetail(stock.id)"  -->
      <tr *ngFor="let product of filteredProducts(); let i = index" (click)="openStockDetail(product.id)" >
        <td [innerHTML]="highlightMatch(product.codeGenerique || '')"></td>
        <td>
          <div class="imgProduit">
            <img [src]="product.photo">
            <!-- <img [src]="(!product.photo || product.photo === 'null' || product.photo.trim() === '') ? 'assets/img/lait.jpeg' : product.photo"> -->
          </div>
          <div class="modal" *ngIf="imagePopup">
            <div class="modal-content" (click)="$event.stopPropagation()">
              <img [src]="imagePopup" alt="Produit">
            </div>
          </div>
        </td>
        <!-- <td>{{product | json}}</td> -->
        <td [innerHTML]="highlightMatch(product.nom)"></td> 
        <!-- <td class="description-cell" (mouseover)="showDescription = true" (mouseout)="showDescription = false">
        <td class="description-cell" (mouseover)="showDescription = true" (mouseout)="showDescription = false">
          {{ product.description | slice:0:20 }}{{ product.description.length > 20 ? '...' : '' }}
          <div class="description-hover" *ngIf="showDescription">{{ product.description }}</div>
        </td>-->
        <td [innerHTML]="highlightMatch(product.nomCategorie || 'non categorie')"></td>
        <td>{{ product.prixVente | customNumber}}</td>
        <td>{{ product.prixAchat | customNumber}}</td>
        <td style="background-color: #0671e410;" [innerHTML]="highlightMatch(product.quantite.toString())"></td>
        <!-- <td>{{ product.nomUnite || 'Non unité' }}</td> -->
        <td [innerHTML]="highlightMatch(product.nomUnite || 'non unite')"></td>
        <td>{{ product.seuilAlert }}</td>
        <ng-container>
          <td  *ngIf="!selectedBoutique">{{ getBoutiqueNames(product.boutiques) }}</td>
        </ng-container>
      </tr>
      <!-- Message si aucun produit ne correspond à la recherche -->
      <tr *ngIf="tasks.length > 0 && filteredProducts().length === 0">
        <td colspan="10" style="text-align: center;">Aucun produit trouvée.</td>
      </tr>
    </tbody>
  </table>

  <!-- Message si aucun produit n'est présent -->
  <div *ngIf="showNoProductsMessage" style="text-align: center; margin-top: 20px;">
    <p style="color: red;">Vous n'avez pas de produit</p>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <mat-paginator *ngIf="tasks.length > 5" [length]="tasks.length"
                   [pageSize]="pageSize"
                   [pageSizeOptions]="[5, 10, 25, 100]"
                   (page)="onPageChange($event)">
    </mat-paginator>
  </div>
</div>
