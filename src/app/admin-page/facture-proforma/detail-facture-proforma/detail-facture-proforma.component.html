<div class="toast-container">

  <div *ngIf="errorMessage" class="alert alert-danger toast-message-danger">
    {{ errorMessage }}
  </div>

</div>

<div class="container_global">
    <div *ngIf="isLoading" class="loading-overlay">
        <div class="loading-content">
          <div class="spinner"></div>
          <p>Connexion en cours...</p>
        </div>
    </div>

    <div *ngIf="factureProForma" class="content_formulaire">
        <div class="modal-body">
            <form class="container_formulaire">

              <fieldset [disabled]="isValidated">
                <!-- // Titre -->
                <div class="Title">
                    <h3>D√©tails de la facture pro forma</h3>
                </div>
                <!-- Les informations de l'etat  -->
                <div class="information_cadre">
                    <div class="info_titre_etat">
                    <h4>√âtat</h4>
                    <div class="etat_container" [class.has-active]="factureProForma.statut">
                        <!-- Section des √©tats -->
                        <div class="etat_content">

                            <!-- Bouton Brouillon -->
                            <div class="etat_brouillon">
                                <button class="btn_etat" 
                                        [class.active]="factureProForma.statut === statusOptions.BROUILLON"
                                        [disabled]="!canTransitionTo(statusOptions.BROUILLON)"
                                        (click)="openStatusConfirmation(statusOptions.BROUILLON)">
                                Brouillon
                                </button>
                            </div>
                            

                            <!-- Bouton Approbation -->
                            <div class="etat_approbation" *ngIf="!factureProForma.dateApprobation">
                                <button class="btn_etat" 
                                        [class.active]="factureProForma.statut === statusOptions.APPROBATION"
                                        [disabled]="!canTransitionTo(statusOptions.APPROBATION)"
                                        (click)="openStatusConfirmation(statusOptions.APPROBATION)">
                                Approbation
                                </button>
                            </div>
                            
                            <!-- Bouton Approuver -->
                            <div class="etat_approuver">
                                <button class="btn_etat" 
                                        [class.active]="factureProForma.statut === statusOptions.APPROUVE"
                                        [disabled]="!canTransitionTo(statusOptions.APPROUVE)"
                                        (click)="openStatusConfirmation(statusOptions.APPROUVE)">
                                Approuver
                                </button>
                            </div>
                            
                            <!-- Bouton Envoyer -->
                            <div class="etat_envoyer">
                                <button class="btn_etat" 
                                        [class.active]="factureProForma.statut === statusOptions.ENVOYE"
                                        [disabled]="!canTransitionTo(statusOptions.ENVOYE)"
                                        (click)="openStatusConfirmation(statusOptions.ENVOYE)">
                                Envoyer
                                </button>
                            </div>
                            
                            <!-- Bouton Valider -->
                            <div class="etat_valider">
                                <button class="btn_etat" 
                                        [class.active]="factureProForma.statut === statusOptions.VALIDE"
                                        [disabled]="!canTransitionTo(statusOptions.VALIDE)"
                                        (click)="openStatusConfirmation(statusOptions.VALIDE)">
                                Valider
                                </button>
                            </div>
                        </div>

                        <!-- Popup de confirmation -->
                        <div *ngIf="showStatusConfirmation" class="status-confirmation-popup">
                            <div class="popup-content">
                            <h4>Confirmer le changement de statut</h4>
                            <p>Voulez-vous vraiment passer la facture au statut "{{ selectedStatutLabel }}" ?</p>
                            <div class="popup-actions">
                                <button class="btn btn-secondary" (click)="cancelStatusChange()">Annuler</button>
                                <button class="btn btn-primary" (click)="confirmStatusChange()">Confirmer</button>
                            </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Les informations de facture  -->
                <div class="information_cadre">
                    <div class="info_titre_input info_titre_input_proforma">
                        <h2>FACTURE PRO FORMA : <span> {{ factureProForma.numeroFacture }} </span></h2>
                        <p style="text-align: right;">{{siege}}, le {{ factureProForma.dateCreation | date:'dd-MM-yyyy' }}</p>
                    </div>
                </div>

                <!-- Les informations de facture  -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                        <div class="champ_input">
                            <!-- <input [value]="factureProForma.description" autocomplete="off" type="text" class="input_focus" required placeholder="Saisis l'object"> -->
                            <textarea [(ngModel)]="factureProForma.description" [ngModelOptions]="{standalone: true}" autocomplete="off" type="text" class="input_focus2" required placeholder="Saisis l'object"></textarea>
                            <label for="object" class="label"> Object </label>
                        </div>
                    </div>
                </div>
                
                <!-- Les informations pour utilisateur  -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                        <div *ngIf="factureProForma.client">
                            <h5>Client</h5>
                            <!-- // Nom complet et email  -->
                            <!-- <div>
                                {{factureProForma | json}}
                            </div> -->
                            <div class="double_input_grid">
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.client.email" type="email" class="input_focus" required placeholder="Saisis l'email">
                                    <label for="email" class="label"> Email </label>
                                </div>
    
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.client.nomComplet" type="text" class="input_focus" required placeholder="Saisis le nom et pr√©nom">
                                    <label for="nomComplet" class="label"> Droit </label>
                                </div>
                            </div>
    
                            <!-- // Adresse et t√©l√©phone  -->
                            <div class="double_input_grid">
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" disabled readonly [value]="factureProForma.client.adresse" type="text" class="input_focus" required placeholder="Saisis l'adresse">
                                    <label for="adresse" class="label"> Adresse </label>
                                </div>
    
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" disabled readonly [value]="factureProForma.client.telephone" type="number" class="input_focus" required placeholder="00 00 00 00">
                                    <label for="numero" class="label"> Num√©ro t√©l√©phone </label>
                                </div>
                            </div>
                        </div>
                        <!-- /////////////////////////////// Entreprise ///////////////////////////////  -->
                        <!-- D√©but de la section Entreprise - Afficher uniquement si entrepriseClient existe -->
                        <div *ngIf="factureProForma.entrepriseClient">
                            <div class="name_icon">
                                <h5>Entreprise clients</h5>
                                <div class="iconEntrepriseList">
                                    <i class="ri-git-branch-fill" title="Affiliation d'Entreprise"></i>
                                </div>
                            </div>

                            <!-- Les chaps d'entreprise -->
                            <div class="double_input_grid">
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.entrepriseClient.nom || 'Non vide' " 
                                        type="text" class="input_focus" required placeholder="Saisis le nom ">
                                    <label for="nom" class="label">Nom</label>
                                </div>

                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.entrepriseClient.email || 'Nom email' " 
                                        type="email" class="input_focus" required placeholder="Saisis l'email">
                                    <label for="totalFacture" class="label">Email</label>
                                </div>
                            </div>

                            <div class="double_input_grid">
                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.entrepriseClient.adresse || 'Nom adresse' " 
                                        type="text" class="input_focus" required placeholder="Saisis l'adresse">
                                    <label for="adresse" class="label">Adresse</label>
                                </div>

                                <div class="champ_input">
                                    <input autocomplete="off" style="cursor: no-drop;" readonly [value]="factureProForma.entrepriseClient.telephone || 'Nom t√©l√©phone' " 
                                        type="number" class="input_focus" required placeholder="00 00 00 00">
                                    <label for="numero" class="label">Num√©ro t√©l√©phone</label>
                                </div>
                            </div>
                        </div>
                        <!-- Fin de la section conditionnelle -->

                    </div>
                </div>

                <!-- // produit ligne  -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                        <div class="add_new_quantite_stock">
                            <h4>Produits</h4>
                        </div>

                        <div class="containerTable">
                            <table>
                                <thead>
                                    <tr class="titleTableProduit">
                                        <th class="title_table_name">D√©signation</th>
                                        <th class="">Description</th>
                                        <th class="">Quantit√©</th>
                                        <th class="">Prix Unitaire</th>
                                        <th class="">Montant (FCFA)</th>
                                    </tr>
                                </thead>
                                <!-- List produit quantite  --> 
                                <tbody>
                                    <tr class="tr_stock" style="border-top: 1px solid #f0f2f5;" *ngFor="let ligne of confirmedLignes; let i = index">
                                        <!-- // Produit  -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <input [value]="getProduitNom(ligne.produitId)" class="input_focus_type" type="text" readonly class="input_table" placeholder="Nom produit">
                                            </div>
                                        </td>
                                        <!-- // Description -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                            <textarea style="margin-bottom: -7px; min-width: 120px; resize: none;"
                                                type="text" [(ngModel)]="ligne.ligneDescription" 
                                                [ngModelOptions]="{standalone: true}"  
                                                class="input_focus_type"
                                                placeholder="Description"></textarea>
                                            </div>                         
                                        </td>
                                        <!-- // Quantit√©  -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <!-- <input  [value]="ligne.quantite" type="number" class="input_focus_type" id="addQuantite" name="addQuantite" placeholder="Quantit√©"> -->
                                                <input [(ngModel)]="ligne.quantite" [ngModelOptions]="{standalone: true}" type="number" class="input_focus_type" id="addQuantite" name="addQuantite" placeholder="Quantit√©">
                                            </div>
                                        </td>
                                        <!-- // Prix Unitaire  -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                            <input 
                                            [value]="getPrixVente(ligne.produitId) | customNumber"
                                                type="text" 
                                                class="input_focus_type" 
                                                placeholder="Prix unitaire"
                                                readonly
                                                style="cursor: no-drop;"
                                            >
                                            </div>
                                        </td>
                                        <!-- // Stock actuel -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                            <input  [value]="getMontantTotal(ligne) | customNumber"
                                                    type="text" 
                                                    class="input_focus_type" 
                                                    disabled
                                                    style="cursor: no-drop;" >
                                            </div>                         
                                        </td>
                                        <td>
                                            <!-- // Button de delele  -->
                                            <div *ngIf="!isValidated" class="btn_delete_icon_add" (click)="supprimerLigneConfirmee(i)">
                                                <i class="ri-delete-bin-5-fill"></i>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <!-- Ajouter produit quantite  -->
                                <tbody>
                                    <tr class="tr_stock" style="border-top: 1px solid #f0f2f5;"  *ngFor="let ligne of inputLignes; let i = index; trackBy: trackByFn">
                                        <!-- // Produit  -->
                                        <div class="champ_input" style="margin-right: 15px;">
                                            <td>
                                                <!-- <select class="input_focus_type input_focus_type_select" 
                                                [(ngModel)]="ligne.produitId" 
                                                (ngModelChange)="updateCalculs()" 
                                                [ngModelOptions]="{standalone: true}">
                                                <option [ngValue]="null">S√©lectionner un produit</option>
                                                <option *ngFor="let produit of produits" [ngValue]="produit.id">
                                                    {{ produit.nom }}
                                                </option>
                                                </select> -->
                                                <select 
                                                    name="produit{{i}}"
                                                    class="input_focus_type input_focus_type_select" 
                                                    [(ngModel)]="ligne.produitId"
                                                    (ngModelChange)="onProduitChange($event, ligne, i)"
                                                    [ngModelOptions]="{ standalone: true }" 
                                                    [ngClass]="{ 'duplicate': ligne.isDuplicate }"
                                                    required>
                                                <option [ngValue]="null">S√©lectionner un produit</option>
                                                    <option *ngFor="let produit of produits" [ngValue]="produit.id">
                                                        {{ produit.nom }}
                                                    </option>
                                                </select>

                                            </td>
                                        </div>
                                        <!-- // Description -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <textarea style="margin-bottom: -7px; min-width: 120px; resize: none;"
                                                type="text"
                                                [(ngModel)]="ligne.ligneDescription"
                                                [ngModelOptions]="{ standalone: true }"
                                                class="input_focus_type"
                                                placeholder="Description"></textarea>
                                            </div>                         
                                        </td>
                                        <!-- // Quantit√©  -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <input type="number" [(ngModel)]="ligne.quantite" 
                                                (ngModelChange)="updateCalculs()" [ngModelOptions]="{standalone: true}"
                                                class="input_focus_type" 
                                                placeholder="Quantit√©">
                                            </div>
                                        </td>
                                        <!-- // Prix Unitaire  -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <input [value]="getPrixVente(ligne.produitId) | customNumber" 
                                                    class="input_focus_type" 
                                                    readonly
                                                    style="cursor: no-drop;"
                                                >
                                            </div>
                                        </td>
                                        <!-- // Stock actuel -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                                <input [value]="getMontantTotal(ligne) | customNumber" 
                                                    class="input_focus_type" 
                                                    readonly
                                                    style="cursor: no-drop;"
                                                >
                                            </div>
                                        </td>
                                        <!-- // Button de ajouter  -->
                                        <td>
                                        <div *ngIf="!isValidated" class="btn_ajouter_icon_add" (click)="ajouterLigneFacture(i)">
                                            <i class="ri-add-fill"></i>
                                        </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <!-- Montant total HT  -->
                                <tfoot>
                                    <tr class="tr_stock">
                                        <!-- // Produit  -->
                                        <td >
                                            <h4>MONTANT TOTAL HT </h4>
                                        </td>
                                        <!-- // Description -->
                                        <td></td>
                                        <!-- // Quantit√©  -->
                                        <td></td>
                                        <!-- // Prix Unitaire  -->
                                        <td></td>
                                        <!-- // Stock actuel -->
                                        <td>
                                            <div class="champ_input" style="margin-right: 15px;">
                                            <input 
                                                type="text" 
                                                class="input_focus_type" 
                                                disabled 
                                                [value]="getTotalHT() | customNumber" 
                                                style="cursor: no-drop; text-align: center;"
                                            >
                                            </div>                         
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Remise -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                    <!-- <h4>Remise</h4> -->
            
                    <div class="champ_input_inventaire">
                        <p>Application de REMISE</p>
                        <label class="switch">
                            <input type="checkbox" [(ngModel)]="activeRemise" (change)="onToggleRemise()" [ngModelOptions]="{standalone: true}"/>
                            <span class="slider round"></span>
                        </label>
                    </div>
            
                    <div class="double_input_grid" *ngIf="activeRemise" style="margin-top: 15px;">
                        <div class="champ_input champ_input2">
                            <input [value]="factureProForma.remise | number" type="number" step="0.01" class="input_focus" name="remisePourcentage" [(ngModel)]="remisePourcentage" placeholder="Remise en %" />
                            <label class="label">
                                REMISE <span *ngIf="remisePourcentage !== null">({{ remisePourcentage }}%)</span>
                            </label>
                        </div>
            
                        <div class="champ_input champ_input2">
                            <input 
                        type="text" 
                        class="input_focus" 
                        readonly
                        [value]="getMontantRemise() | customNumber" style="cursor: no-drop;"/>
                            <label class="label">Montant (CFA)</label>
                        </div>
                    </div>
            
                    </div>
                </div>

                <!-- // Toatal TTC  -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                        <!-- // Remise et Total hors taxe  -->
                        <div class="double_input_ttc">
                            <h4> MONTANT COMMERCIAL </h4>
                            <!-- Montant Commercial -->
                            <div class="montantTTC">
                                <!-- <h4> -->
                                    {{ getTotalCommercial() | customNumber  }} CFA
                                <!-- </h4> -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TVA -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                    <!-- <h4> TVA </h4> -->
            
                    <div class="champ_input_inventaire">
                        <p>Application de TVA</p>
                        <label class="switch">
                            <input type="checkbox" [(ngModel)]="activeTva" (change)="onToggleTVA()" [ngModelOptions]="{standalone: true}"/>
                            <span class="slider round"></span>
                        </label>
                    </div>
            
                    <div class="double_input_grid" *ngIf="activeTva" style="margin-top: 15px;">
                        <div class="champ_input">
                          <input type="text" class="input_focus" readonly [value]="tauxTva != null ? ((tauxTva * 100) | number:'1.0-0') + '%' : ''" />
                            <label class="label">TVA (%)</label>
                        </div>
                        
                        <div class="champ_input champ_input2">
                            <input type="text" class="input_focus" readonly [value]="getMontantTVA() != null ? (getMontantTVA() | number:'1.0-3') : ''" style="cursor: no-drop;"/>
                            <label class="label">Montant (CFA)</label>
                        </div>
            
                    </div>
            
                    </div>
                </div>
                <!-- // Toatal ht et ttc  -->
                <div class="information_cadre">
                    <div class="info_titre_input">
                        <!-- // Remise et Total hors taxe  -->
                        <div class="double_input_ttc">
                            <h4>MONTANT TOTAL TTC </h4>
                            <div class="montantTTC">
                                {{ getTotalTTC() | customNumber }} CFA
                            </div>
                        </div>
                    </div>
                </div>
              </fieldset>

                <!-- Buttom ajouter et annuler  -->
                <div class="information_cadre" style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="cursor: pointer; text-align: left; margin-left: 20px;">
                        <button class="btn_apercu" title="Voir l'aper√ßu de facture proforma" (click)="apercuFactureProformaDansDetail()">Aper√ßu  <i class="ri-eye-2-line"></i></button>
                    </div>
                    <!-- /////////  -->
                    <div class="info_titre_input info_titre_input_btn">
                        <!-- Input de produits  -->
                        <div class="btn_annuler">
                            <button class="btn_cancel" (click)="getAnnulerDetail()">Annuler</button>
                        </div>
        
                        <div class="btn_ajouter">
                            <button *ngIf="!isValidated" class="btn_save" type="submit" (click)="submitUpdateForm()">Modifier</button>
                        </div>
                    </div>
                </div>
                <!-- Message d'erreur global -->
                <div class="container_error_message">
                    <div *ngIf="errorMessage" class="error-message">
                        {{ errorMessage }}
                    </div>
                </div>
            </form>
        </div>
    </div>
 
    <!-- Remplacer toute la section container_brouillon_facture par -->
    <div class="container_brouillon_facture">
        <div class="historical-timeline">
                    
                            <!-- Titre + ic√¥ne -->
                            <div class="title_historique" style="display: flex; align-items: center; justify-content: space-between;">
                                <h6 style="margin: 0;">Historique des actions</h6>
                                <i class="ri-file-edit-line" 
                                    style="font-size: 1.1rem; cursor: pointer; color: #555;"
                                    (click)="toggleNotebook()"
                                    title="Voir le cahier de notes">
                                </i>
                            </div>

                            <!-- Fiche (bloc-notes) -->
                        <div class="note-notebook" *ngIf="isNotebookOpen">
                                <div class="notebook-header">
                                    <span class="title">üóíÔ∏è Mes notes</span>

                                    <!-- ‚ûï Ajouter une note -->
                                    <i
                                    *ngIf="!isAddNoteInputVisible"
                                    class="ri-add-line add-icon icon"
                                    (click)="toggleAddNoteInput()"
                                    title="Ajouter une note"
                                    ></i>

                                    <!-- Save when il y a du texte -->
                                    <i
                                    *ngIf="isAddNoteInputVisible && noteModification.trim() !== ''"
                                    class="ri-save-line add-icon icon"
                                    (click)="submitNote()"
                                    title="Enregistrer"
                                    ></i>

                                    <!-- close quand champ vide -->
                                    <i
                                    *ngIf="isAddNoteInputVisible && noteModification.trim() === ''"
                                    class="ri-close-line close-icon icon"
                                    (click)="closeNoteInput()"
                                    title="Annuler"
                                    ></i>
                                </div>

                                        <!-- Champ de saisie -->
                                        <div class="add-note-inline" *ngIf="isAddNoteInputVisible">
                                            <textarea
                                            [(ngModel)]="noteModification"
                                            placeholder="√âcris quelque chose..."
                                            rows="4"
                                            ></textarea>
                                        </div>

                            <!-- Liste des notes -->
                              
                            <ul class="note-list">
                                <span *ngIf="infoMessage" class="message-notes">
                                {{ infoMessage }}
                                </span>

                                    <li *ngFor="let note of notes; let i = index">
                                        <div class="note-item position-relative">
                                        <!-- Ic√¥ne trois points en haut √† droite -->
                                        <div class="note-options">
                                            <i 
                                            class="ri-more-2-fill" 
                                            (click)="toggleNoteMenu(i)" 
                                            title="Options"
                                            ></i>

                                            <!-- Menu d√©roulant -->
                                         <div class="note-menu" *ngIf="activeMenuIndex === i">
                                            <button (click)="editNote(i)">‚úèÔ∏è Modifier</button>
                                            <ng-container *ngIf="confirmDeleteIndex === i; else showDeleteButton">
                                                <div class="confirm-dialog">
                                                    <p>Voulez-vous vraiment supprimer cette note ?</p>
                                                    <div class="confirm-dialog-buttons">
                                                        <button (click)="confirmDelete(i)">Oui</button>
                                                        <button (click)="cancelDelete()">Non</button>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <ng-template #showDeleteButton>
                                                <button (click)="askDelete(i)">üóëÔ∏è Supprimer</button>
                                            </ng-template>
                                        </div>

                                        </div>
                                        <!-- Contenu de la note -->
                                        

                                        <div class="note-text">{{ note.content }}</div>

                                        <div class="note-meta">
                                            <span *ngIf="note.dateCreation" class="meta-date">{{ note.dateCreation | date:'dd/MM/yyyy HH:mm' }} ‚¶ø </span>
                                            <span class="meta-author">{{ note.auteur }}</span>
                                            <span *ngIf="note.modifiee" class="badge-modified">Modifi√©e</span>
                                            <span class="meta-numeroIdentifiant">{{ note.numeroIdentifiant }}</span>
                                        </div>
                                        </div>
                                    </li>
                            </ul>


                        </div>

                        <div class="timeline-container">
                            <div *ngFor="let event of historicalEvents" class="timeline-event">
                                <div class="event-avatar">
                                    <img [src]="event.user.photo || 'assets/img/profil.png'" alt="Avatar" class="avatar"
                                     (error)="event.user.photo = 'assets/img/profil.png'">

                                </div>
                                
                                <div class="event-content">
                                    <div class="event-header">
                                        <span class="user-name">{{event.user.nomComplet}}</span>
                                        <span class="event-date">{{event.date | date: 'dd/MM/yyyy HH:mm'}}</span>
                                    </div>
                                
                                    <div class="event-action" [ngClass]="{
                                        'creation': event.type === 'creation',
                                        'approbation': event.type === 'approbation',
                                        'envoi': event.type === 'envoi',
                                        'validation': event.type === 'validation'
                                    }">
                                        <i class="action-icon" [ngClass]="{
                                        'ri-file-add-line': event.type === 'creation',
                                        'ri-checkbox-circle-line': event.type === 'approbation',
                                        'ri-send-plane-line': event.type === 'envoi',
                                        'ri-shield-check-line': event.type === 'validation'
                                        }"></i>
                                        {{event.description}}
                                        <div class="status-badge" *ngIf="event.status">
                                            {{event.status}}
                                        </div>
                                        
                                        <!-- Afficher les approbateurs pour les demandes d'approbation -->
                                        <div *ngIf="event.status === 'APPROBATION'" class="approbateurs-list">
                                            <span *ngFor="let approbateur of factureProForma.approbateurs">
                                                {{approbateur.nomComplet}}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
         </div>
    </div>
    
</div>

<div *ngIf="showDuplicatePopup" class="duplicate-popup">
    <div class="popup-content">
      <p>Ce produit est d√©j√† dans la liste.</p>
      <button (click)="closePopup()">OK</button>
    </div>
</div>

<!-- Popup de confirmation -->
<div *ngIf="showStatusConfirmation" class="status-confirmation-popup">
    <div class="popup-content">
      <h4>Confirmer le changement de statut</h4>
      <p>√ätes-vous s√ªr de vouloir <span class="highlighted-status">{{ selectedStatutLabel }}</span> cette facture ?</p>
      <!-- Date de relance si ENVOYE -->
      <div *ngIf="pendingStatut === 'ENVOYE'" class="form-group">
        <label for="relanceDate" style="font-size: 12px;">Date de relance (facultative) :</label>
        <input type="datetime-local" id="relanceDate" [(ngModel)]="dateRelance" class="form-control"/>
      </div>
  
      <div class="popup-actions">
        <button class="btn btn-secondary" (click)="cancelStatusChange()">Annuler</button>
        <button class="btn btn-primary" (click)="confirmStatusChange()">Confirmer</button>
      </div>
    </div>
</div>

<!-- Liste des utilisateurs √† cocher si statut = Approbation -->
<div *ngIf="showStatusConfirmation" class="status-confirmation-popup">
    <div class="popup-content">
        <h4>Confirmer le changement de statut</h4>
        <p>
        √ätes-vous s√ªr de vouloir 
        <span class="highlighted-status">{{ selectedStatutLabel }}</span> 
        cette facture ?
        </p>

        <!-- Affichage conditionnel selon le statut -->
        <div *ngIf="pendingStatut === 'ENVOYE'" class="form-group">
            <label for="relanceDate" style="font-size: 12px;">Date de relance (facultative) :</label>
            <input type="datetime-local" id="relanceDate" [(ngModel)]="dateRelance" class="form-control" />
        </div>

        <!-- ‚úÖ Liste des utilisateurs pour l'approbation -->
        <div *ngIf="pendingStatut === 'APPROBATION'" class="form-group">
        <label style="font-size: 12px;">S√©lectionnez les utilisateurs √† notifier :</label>
        <div *ngIf="users.length === 0">Aucun utilisateur √† afficher</div>

            <div *ngFor="let user of users" style="display: flex; align-items: center;">
            <input
                type="checkbox" 
                [(ngModel)]="user.selected"
                id="user_{{ user.id }}"
                style="margin-right: 8px; margin-bottom: 8px;"
            />
            <label for="user_{{ user.id }}">
                {{ user.nomComplet }} - {{ user.phone }}
            </label>
            </div>

        </div>

        <div class="popup-actions">
        <button class="btn btn-secondary" (click)="cancelStatusChange()">Annuler</button>
        <button class="btn btn-primary" (click)="confirmStatusChange()">Confirmer</button>
        </div>
    </div>
</div>

<!-- Ajouter dans le template existant -->
<div *ngIf="showEmailPopup" class="status-confirmation-popup-envoyer email-popup">
    <div class="popup-content-envoyer"[ngStyle]="{
       'transform': 'translate3d(' + popupOffset.x + 'px, ' + popupOffset.y + 'px, 0)'}">
        <div class="envoyer_croix" (mousedown)="startDrag($event)">
                    <div class="titre_etat">
                        <p>Methode d'envoi : </p>

                        <div class="checkbox-group" (mousedown)="$event.stopPropagation()">
                        <label class="custom-radio">
                            <input
                            type="radio"
                            name="methodeEnvoi"
                            value="physique"
                            [(ngModel)]="methodeEnvoi"
                            (change)="onMethodeEnvoiChange()"
                            />
                            <span class="radio-mark"></span>
                            Physique
                        </label>

                        <label class="custom-radio">
                            <input
                            type="radio"
                            name="methodeEnvoi"
                            value="email"
                            [(ngModel)]="methodeEnvoi"
                            (change)="onMethodeEnvoiChange()"
                            />
                            <span class="radio-mark"></span>
                            Email
                        </label>
                        </div>
                    </div>

            <div class="icon_croix" (click)="showEmailPopup = false" (mousedown)="$event.stopPropagation()">
                <i class="ri-close-large-line"></i>
            </div>
        </div>




        <div class="barre"></div>

        <div class="contenue_form_envoyer" *ngIf="methodeEnvoi === 'email'">
            <!-- // email field  -->
            <div class="email_field">
                <!-- // Titre email field -->
                <div class="titre_email_field titre_email_field_vers">
                    √Ä
                </div>
                <!-- // Input email field -->
                <div class="input_email_field">
                    <div class="champ_input" style="margin-right: 15px;">
                        <div class="email-input-container">
                            <!-- Emails sous forme de puces dans l'input -->
                            <span *ngFor="let email of emailDestinatairesList; let i = index" class="email-chip  email-chip-cc">
                                {{email}}
                                <span class="remove-chip" (click)="removeEmail(i)">‚úñ</span>
                            </span>
                            
                            <!-- Champ de saisie int√©gr√© -->
                            <input 
                                type="text"
                                [(ngModel)]="currentEmail"
                                (keydown.enter)="addEmail()"
                                (keydown.backspace)="handleBackspace()"
                                placeholder="Ajouter des destinataires..."
                                class="inline-email-input"
                            >
                        </div>
                    </div>
                </div>
            </div>

                 <!-- // Cc email field -->
            <div class="email_field" >
                <!-- // Titre email field -->
                <div class="titre_email_field titre_email_field_vers">
                    Cc
                </div>
                <!-- // Input email field -->
                <div class="input_email_field">
                    <div class="champ_input" style="margin-right: 15px;">
                        <div class="email-input-container">
                           <span *ngFor="let email of emailCcList; let i = index" class="email-chip">
                            {{email}}
                            <span 
                                class="remove-chip" 
                                *ngIf="email !== emailUtilisateur" 
                                (click)="removeCcEmail(i)"
                            >‚úñ</span>
                            </span>

                            <input 
                                type="text"
                                [(ngModel)]="currentCcEmail"
                                (keydown.enter)="addCcEmail()"
                                (keydown.backspace)="handleCcBackspace()"
                                placeholder="Ajouter des adresses en copie..."
                                class="inline-email-input"
                            >
                        </div>
                    </div>
                </div>
            </div>


            <!-- // Suject field  -->
            <div class="email_field">
                <!-- // Titre email field -->
                <div class="titre_email_field">
                    Objet
                </div>
                <!-- // Input email field -->
                <div class="input_email_field">
                    <div class="champ_input" style="margin-right: 15px;">
                        <!-- <input #subjectInput class="input_focus_type" type="text" class="input_table_des" placeholder="Bienvenue √† MyCompany !" value="Facture pro forma ${factureProForma.numeroFacture}"> -->
                         <input #subjectInput 
                            class="input_focus_type input_table_des" 
                            type="text" 
                            placeholder="Bienvenue √† MyCompany !" 
                            [value]="'Facture pro forma ' + (factureProForma.numeroFacture || '')">
                    </div>
                </div>
            </div>

            <!-- Contenu existant de l'email -->
            <div class="email-body">
                <div class="editable-content" contenteditable="true" #editableContent>
                    Bonjour {{ destinataire.nom }} ,<br><br>
                    Suite √† notre √©change, veuillez trouver ci-joint <strong>la facture proforma</strong> correspondant √† votre demande.<br>
                    N‚Äôh√©sitez pas √† revenir vers nous si vous avez besoin d‚Äôinformations compl√©mentaires ou si des ajustements sont n√©cessaires.<br><br>
                    Nous restons √† votre disposition pour finaliser la commande d√®s validation de votre part.<br><br>

                   Bien cordialement,<br><br>
                   
                    ---<br>
                    {{ nomEntreprise }}
                    
                </div>
            </div>

            <!-- Remplacer la section pdf -->
            <div class="section_img_pdf">
                <ul>
                    <!-- Afficher toutes les pi√®ces jointes, y compris le PDF g√©n√©r√© -->
                    <li class="cadre_pdf" *ngFor="let att of attachments; let i = index">
                    <span class="text-truncate">{{ att.name }}</span>
                    <button class="btn flex-shrink-0" (click)="removeAttachment(i)">
                        <i class="fa fa-fw fa-times"></i>
                    </button>
                    </li>
                </ul>

                <input #fileInput type="file" hidden 
                    (change)="onFileSelected($event)" 
                    multiple
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
            </div>
        </div>

      <div class="contenue_form_envoyer contenue_form_image_physique conteneur_horizontal" *ngIf="methodeEnvoi === 'physique'">
            <div class="image_delivery">
                <img src="assets/img/physique.png" alt="Physique">
                <p class="tchia">TCHAK3DA</p>
            </div>
            <div class="infos-physique">
            <p class="instruction">üìç Veuillez d√©poser la facture √† l'adresse suivante :</p>
            <table class="infos-table">
                <tr>
                    <td class="label">{{ labelNom }} :</td>
                    <td class="value">{{ destinataire.nom }}</td>
                </tr>

                 <tr *ngIf="destinataire.siege">
                    <td class="label">Si√®ge :</td>
                    <td class="value">{{ destinataire.siege }}</td>
                </tr>

                <tr>
                    <td class="label">Adresse :</td>
                    <td class="value">{{ destinataire.adresse }}</td>
                </tr>
               
                <tr *ngIf="destinataire.ville">
                    <td class="label">Ville :</td>
                    <td class="value">{{ destinataire.ville }}</td>
                </tr>

                <tr>
                    <td class="label">Pays :</td>
                    <td class="value">{{ destinataire.pays }}</td>
                </tr>

                <tr>
                    <td class="label">T√©l√©phone :</td>
                    <td class="value">{{ destinataire.telephone }}</td>
                </tr>

                <tr>
                    <td class="label">Email :</td>
                    <td class="value">{{ destinataire.email }}</td>
                </tr>
            </table>
            </div>



             </div>



            <div class="footer_btn">
                <div class="content_footer">
                    <div class="contenue_footer_btn">
                        <div class="btn_envoie_save">
                            <!-- Bouton adapt√© √† la m√©thode -->
                            <button *ngIf="methodeEnvoi === 'email'" 
                                class="btn" 
                                (click)="confirmEmailSend()"
                                [disabled]="!emailDestinatairesList.length || isSending">
                                <span *ngIf="!isSending">Envoyer</span>
                                <div *ngIf="isSending" class="mini-spinner"></div>
                            </button>
            
                            <button *ngIf="methodeEnvoi === 'physique'" 
                                    class="btn" 
                                    (click)="confirmEmailSend()"
                                    [disabled]="isSending">
                                <span *ngIf="!isSending">Confirmer</span>
                                <div *ngIf="isSending" class="mini-spinner"></div>
                            </button>
                        </div>
                   

                        <div class="icon_attach" 
                            (click)="triggerFileInput()" 
                            *ngIf="methodeEnvoi === 'email'"
                            title="Ajouter des pi√®ces jointes">
                            <i class="ri-attachment-2"></i>
                        </div>

                        <!-- <div class="icon_relance">
                            <i class="ri-time-line" title="Date de relance"></i>
                        </div> -->

                </div>

                    <!-- Affichage conditionnel selon le statut  *ngIf="pendingStatut === 'ENVOYE'" -->
                    <!-- S√©lecteur de date de relance -->
                <div class="form-group">
                    <label for="relanceDate">Date de relance :</label>
                    <input type="datetime-local" 
                            id="relanceDate" 
                            [(ngModel)]="dateRelance" 
                            class="form-control form-control-date">
                </div>
                </div>
            </div>
    </div>
</div>
