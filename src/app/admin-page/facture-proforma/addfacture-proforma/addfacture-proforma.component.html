<div class="container_global">
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Connexion en cours...</p>
    </div>
  </div>

  <div class="content_formulaire">
    <div class="modal-body">
        <form class="container_formulaire">
            <!-- // Titre -->
            <div class="Title">
                <h3>Ajouter une facture proforma</h3>
            </div>

            <!-- Les informations de facture  -->
            <div class="information_cadre">
                <div class="info_titre_input">
                    <h4>Client(e)</h4>

                     <!-- Client / Entreprise -->
                     <div class="champ_input champ_input2">
                      <div class="title_input">
                        <label>
                          <input type="radio" name="typeDestinataire" value="client" [(ngModel)]="typeDestinataire" [ngModelOptions]="{ standalone: true }" />
                          Client
                        </label>
                        <label style="margin-left: 20px;">
                          <input type="radio" name="typeDestinataire" value="entreprise" [(ngModel)]="typeDestinataire" [ngModelOptions]="{ standalone: true }" />
                          Entreprise
                        </label>
                      </div>
        
                      <!-- Select Client -->
                      <select *ngIf="typeDestinataire === 'client'" class="input_focus" [(ngModel)]="selectedClientId" name="client_id" required>
                        <option [ngValue]="null">Sélectionner un client</option>
                        <option *ngFor="let client of clients" [ngValue]="client.id">
                          {{ client.nomComplet }} <span *ngIf="client.entrepriseClient"> - {{ client.entrepriseClient.nom }}</span>
                        </option>
                      </select>
        
                      <!-- Select Entreprise -->
                      <select *ngIf="typeDestinataire === 'entreprise'" class="input_focus" [(ngModel)]="selectedEntrepriseId" name="entreprise_id" required [ngModelOptions]="{ standalone: true }" >
                        <option [ngValue]="null">Sélectionner une entreprise</option>
                        <option *ngFor="let entreprise of entreprises" [value]="entreprise.id">
                          {{ entreprise.nom }}
                        </option>
                      </select>
                    </div>

                    <!-- Description -->
                    <div class="champ_input">
                      <input type="text" class="input_focus2" id="description" name="description" [(ngModel)]="description" [ngModelOptions]="{ standalone: true }" placeholder="Saisis la description" />
                      <label for="description" class="label">Description</label>
                    </div>
                </div>
            </div>

             <!-- Lignes produit de facture dynamiques -->
            <div class="information_cadre">
                <div class="info_titre_input">
                    <div class="add_new_quantite_stock">
                        <h4>Produits</h4>
                    </div>

                    <div class="containerTable">
                        <table>
                            <thead>
                                <tr class="titleTableProduit">
                                    <th class="title_table_name">Mes produits</th>
                                    <th class="title_table_stock">Stock actuel</th>
                                    <th class="title_table_quantite">Quantité</th>
                                </tr>
                            </thead>
                            <!-- Annuler produit quantite  -->
                            <tbody>
                                <tr class="tr_stock" style="border-top: 1px solid #f0f2f5;">
                                    <!-- // Produit  -->
                                    <td>
                                        <div class="champ_input" style="margin-right: 15px;">
                                            <input class="input_focus_type" type="text" readonly class="input_table">
                                        </div>
                                    </td>
                                    <!-- // Stock actuel -->
                                    <td>
                                      <div class="champ_input" style="margin-right: 15px;">
                                        <input type="text" class="input_focus_type" readonly id="stockActuel" name="stockActuel" style="cursor: no-drop; text-align: center;">
                                      </div>                         
                                    </td>
                                    <!-- // Quantité  -->
                                    <td>
                                        <div class="champ_input" style="margin-right: 15px;">
                                            <input type="number" readonly class="input_focus_type input_focus_type_select" id="addQuantite" name="addQuantite" placeholder="0" min="0">
                                        </div>
                                    </td>
                                    <td>
                                        <!-- // Button de delele  -->
                                        <div class="btn_delete_icon_add">
                                          <i class="ri-delete-bin-5-fill"></i>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <!-- Ajouter produit quantite  -->
                            <tbody>
                                <tr class="tr_stock" style="border-top: 1px solid #f0f2f5;"  *ngFor="let ligne of lignesFacture; let i = index">
                                    <!-- // Produit  -->
                                    <td>
                                      <div class="champ_input" style="margin-right: 15px;">
                                        <select 
                                          class="input_focus_type input_focus_type_select" 
                                          [(ngModel)]="ligne.produitId" 
                                          [ngModelOptions]="{ standalone: true }" required>
                                          <option [ngValue]="null">Sélectionner un produit</option>
                                          <option *ngFor="let produit of produits" [ngValue]="produit.id">
                                            {{ produit.nom }}
                                          </option>
                                        </select>
                                      </div>
                                    </td>
                                    <!-- // Stock actuel -->
                                    <td>
                                      <div class="champ_input" style="margin-right: 15px;">
                                        <input 
                                          type="text" 
                                          class="input_focus_type" 
                                          disabled 
                                          [value]="getStockActuel(ligne.produitId)"
                                          style="cursor: no-drop; text-align: center;"
                                        >
                                      </div>
                                    </td>
                                    <!-- // Quantité  -->
                                    <td>
                                        <div class="champ_input" style="margin-right: 15px;">
                                          <input type="number" class="input_focus input_focus_type" [(ngModel)]="ligne.quantite" [ngModelOptions]="{ standalone: true }" placeholder="Quantité" />
                                            <label class="label">Quantité</label>
                                        </div>
                                    </td>
                                    <!-- // Button de ajouter  -->
                                    <td>
                                      <div class="btn_ajouter_icon_add" (click)="ajouterLigneFacture()">
                                        <i class="ri-add-fill"></i>
                                      </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Remise et TVA -->
            <div class="information_cadre">
              <div class="info_titre_input">
                <h4>Remise et TVA</h4>
      
                <div class="champ_input_inventaire">
                  <p>Application de remise et TVA</p>
                  <label class="switch">
                    <input
                      type="checkbox"
                      [(ngModel)]="remiseTVAActive"
                      (change)="onToggleRemiseTVA()"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span class="slider round"></span>
                  </label>
                </div>
      
                <div class="double_input" *ngIf="remiseTVAActive" style="margin-top: 15px;">
                  <div class="champ_input champ_input2">
                    <input
                      type="number"
                      step="0.01"
                      class="input_focus"
                      name="remisePourcentage"
                      [(ngModel)]="remisePourcentage"
                      placeholder="Remise en %"
                    />
                    <label class="label">Remise (%)</label>
                  </div>
      
                  <div class="champ_input champ_input2">
                    <input
                      type="number"
                      class="input_focus"
                      name="tva"
                      [(ngModel)]="tva"
                      placeholder="TVA"
                    />
                    <label class="label">TVA</label>
                  </div>
                </div>
      
              </div>
            </div>

            <!-- Boutons -->
            <div class="information_cadre information_cadre_save">
              <div class="info_titre_input info_titre_input_btn" style="display: flex; justify-content: flex-end; gap: 10px;">
                <div class="btn_annuler">
                  <button class="btn_cancel" type="button" (click)="goToFacture()">Annuler</button>
                </div>
                <div class="btn_ajouter">
                  <button class="btn_save" (click)="creerFactureProforma()">Ajouter</button>
                </div>
              </div>
            </div>

        </form>
        
    </div>
  </div>
</div>



  