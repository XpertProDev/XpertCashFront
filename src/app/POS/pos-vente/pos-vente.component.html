<div class="section_contenu_container">
  <!-- // section contenu left -->
  <div class="section_contenu_left">
    <!-- // section favory produit -->
    <div class="section_favory_produit">
      <!-- // section favory -->
      <div class="section_favory">
        <!-- // ul pour le favory  -->
        <!-- <ul class="ul_section_favory">
          <li class="li_section_favory" style="display: flex; align-items: center; justify-content: space-between;">
            <div class="double">
              <div class="icon_favory">
                <i class="ri-heart-fill"></i>
              </div>
              <p class="title_favory">Favorie</p>
            </div>

            <div class="nombre_favory">
              03
            </div>
          </li>
        </ul> -->
        <!-- // categorie -->
        <div class="titre_categorie" [class.selected]="selectedCategoryId === null">
          <div class="category-header">
            <p (click)="showAllProducts()" class="allCate">
             Toutes les catégories</p>
            <div class="scan-controls">
              <button class="scan-test-btn" (click)="testScan('6920484370182')" title="Test scan avec code 6920484370182">
                <i class="ri-barcode-line"></i> Test Scan
              </button>
              <button class="scan-reload-btn" (click)="reloadProductsForScan()" title="Recharger les produits">
                <i class="ri-refresh-line"></i> Reload
              </button>
              <button class="scan-status-btn" (click)="checkScannerStatus()" title="Vérifier l'état du scanner">
                <i class="ri-information-line"></i> Status
              </button>
              <button class="scan-test-multi-btn" (click)="testScannerWithCodes()" title="Test avec plusieurs codes">
                <i class="ri-test-tube-line"></i> Test Multi
              </button>
              <!-- <button class="scan-reset-btn" (click)="resetScanner()" title="Réinitialiser le scanner">
                <i class="ri-restart-line"></i> Reset
              </button> -->
              <span class="scan-status" [class.active]="!scanInProgress">
                <i class="ri-wifi-line"></i> Scanner {{ scanInProgress ? 'Actif' : 'Prêt' }}
              </span>
            </div>
          </div>
        </div>
        <ul class="ul_name_categorie" *ngIf="categories.length">
          <!-- Boucle sur les catégories -->
          <li *ngFor="let categorie of categories" 
              class="ul_li_name_categorie"
              [class.selected]="selectedCategoryId === categorie.id"
              (click)="selectCategory(categorie.id)" >
            <div class="name_categorie">
              <span>{{ categorie.nom }}</span>
            </div>
            <!-- <div class="nombre">
                {{ categorie.produitCount || 0 }}
            </div> -->
            <div class="nombre">
              {{ getCategoryProductCount(categorie) }}
            </div>
          </li>
        </ul>
      </div>
      <!-- // section produit -->
      <div class="section_produit">
        <!-- on transforme cadre_produit en container de grille -->
        <div class="cadre_produit product-grid" *ngIf="isListView">
          
          <div class="product-card"
               *ngFor="let produit of getVisibleProducts()"
                  [class.disabled]="getAvailableStock(produit) <= 0"
                  (click)="addToCart(produit)"
                  (pointerdown)="startPress($event, produit)"
                  (pointerup)="endPress()"
                  (pointerleave)="endPress()">
            <!-- pastille de stock en haut à gauche -->
            <span class="stock-badge" *ngIf="getSelectedQuantity(produit.id) > 0">
              {{ getSelectedQuantity(produit.id) }}
            </span>

            <!-- image produit -->
            <img [src]="getProductImage(produit.photo)" alt="" class="product-img">

            <!-- cœur favori -->
            <!-- <i class="ri-heart-line favorite-icon"></i> -->

            <!-- zone texte -->
            <div class="card-body">
              <p class="product-name">{{ produit.nom }}</p>
              <p class="product-stock">Stocks : {{ getAvailableStock(produit) }}</p>
            </div>

            <div class="bottom_price_sub">
              <div class="product-price">
                <p>{{ produit.prixVente | cfaCurrency }}</p>
              </div>
              <button class="btn-decrement" (click)="decreaseQuantity(produit); $event.stopPropagation()">
                <i class="ri-subtract-line"></i>
              </button>
            </div>
          </div>

          <div *ngIf="!categories.length" class="loading-indicator">
            <i class="ri-loader-4-line"></i> Chargement des produits...
          </div>

        </div>

        <!-- Mode Liste -->
        <div class="cadre_produit_list product-list" *ngIf="!isListView">
          <ul class="ul_list">
            <li class="li_list" 
                 *ngFor="let produit of getVisibleProducts()"
                  [class.disabled]="getAvailableStock(produit) <= 0"
                  (click)="addToCart(produit)"
                  (pointerdown)="startPress($event, produit)"
                  (pointerup)="endPress()"
                  (pointerleave)="endPress()">
              <div class="list_left">
                <div class="double">
                  <div class="img_product_list">
                    <img [src]="getProductImage(produit.photo)" alt="">
                  </div>
                  <div class="name_stock_list">
                    <p class="product-name-list">{{ produit.nom }}</p>
                    <p class="product-stock-list">Stocks : {{ getAvailableStock(produit) }}</p>
                  </div>
                </div>
              </div>
              
              <div class="list_right">
                <div class="double" style="gap: 10px;">
                  <div class="product-price">
                    <p>{{ produit.prixVente | cfaCurrency }}</p>
                  </div>
                  <div class="btn_badge">
                    <span class="stock-badge-list" *ngIf="getSelectedQuantity(produit.id) > 0">
                      {{ getSelectedQuantity(produit.id) }}
                    </span>
                  </div>
                  <button class="btn-decrement" (click)="decreaseQuantity(produit); $event.stopPropagation()">
                    <i class="ri-subtract-line"></i>
                  </button>
                  <!-- <div class="btn_fovory">
                    <i class="ri-heart-line favorite-icon-list"></i>
                  </div> -->
                </div>
              </div>
            </li>
          </ul>
          <div *ngIf="displayedProducts.length === 0 && categories.length" class="empty-category">
            Aucun produit dans cette catégorie
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- // section contenu right -->
  <div class="section_contenu_right" style="background-color: #ffffff; height: 100vh; box-shadow: rgba(0, 0, 0, 0.04) 0px 3px 5px;">
    <div class="list_produit_select">
      <!-- // Tout les liste de produc select  -->
      <ul class="ul_list_produit_select">
        <li class="li_list_produit_select" (click)="selectProductForDiscount(item.product)"
            *ngFor="let item of getCartItems()">
          <div class="double" style="gap: 5px;">
            <div class="nombre_select">
              {{ item.quantity }}
            </div>
            <div class="name_produit_select">
              <p style="margin: 0;">
                {{ item.product.nom }}
                <span>({{ item.product.prixVente | cfaCurrency }})</span>
                <!-- Indicateur de remise -->
                <span *ngIf="getProductDiscount(item.product.id) > 0" class="discount-badge">
                  {{ getProductDiscount(item.product.id) | cfaCurrency }}
                </span>
              </p>
            </div>
          </div>
          <div class="double" style="gap: 5px;">
            <div class="price_produit">
              {{ calculateItemTotal(item) | cfaCurrency }}
            </div>
            <div class="icon_close_select" 
              *ngIf="inputMode !== 'discount' && !isEditingDiscount(item.product.id)" 
              (click)="removeProduct(item.product.id)">
            <i class="ri-close-circle-fill"></i>
          </div>
            <!-- Bouton pour modifier la remise -->
           <div class="edit-discount" 
                *ngIf="inputMode === 'discount'"
                (click)="isEditingDiscount(item.product.id) ? saveDiscount(item.product) : editDiscount(item.product)">
              <i [class]="isEditingDiscount(item.product.id) ? 'ri-check-fill' : 'ri-edit-2-line'"></i>
            </div>
          </div>
        </li>
      </ul>

      <!-- <div class="double_row">
        <span>Sous-total</span>
        <span>{{ getSubtotal() | cfaCurrency }}</span>
      </div>
      <div class="double_row">
        <span>Remise totale</span>
        <span>-{{ getTotalDiscount() | cfaCurrency }}</span>
      </div>
      <div class="double_row total">
        <strong>Total</strong>
        <strong>{{ getTotalCart() | cfaCurrency }}</strong>
      </div> -->
    </div>
    
    <!-- 2. Récapitulatif : Remise / Taxes / Total -->
    <div class="summary_panel">
      <!-- <div class="double_row">
        <span>Remise</span>
        <span>00 CFA</span>
      </div> -->
      <div class="double_row">
        <span>Taxes</span>
        <span>00 CFA</span>
      </div>
      <div class="double_row total">
        <strong>Total</strong>
        <strong>{{ getTotalCart() | cfaCurrency }}</strong>
      </div>

      <!-- Dans la section remise -->
      <div class="discount-input" *ngIf="discountMode.active">
        <button class="btn-currency" 
                [class.active]="discountMode.type === 'CFA'"
                (click)="setDiscountType('CFA')">
          CFA
        </button>
        
        <!-- Modifier ici : utiliser currentDiscountInput -->
        <!-- <input 
          type="number" 
          placeholder="0" 
          class="input-discount"
          [value]="currentDiscountInput"
          (input)="onDiscountInputChange($event)"
          (focus)="disablePhysicalKeyboard = true"
          (blur)="disablePhysicalKeyboard = false"
          min="0"> -->
          <input 
            type="number" 
            placeholder="0" 
            class="input-discount"
            [value]="currentDiscountInput"
            (input)="onDiscountInputChange($event)"
            (focus)="onInputFocus()"
            (blur)="onInputBlur()"
            min="0">
        
        <button class="btn-percent" 
                [class.active]="discountMode.type === '%'"
                (click)="setDiscountType('%')">
          %
        </button>
      </div>

    </div>

    <!-- <div class="quantity-input-display" *ngIf="selectedProduct">
      Produit: {{ selectedProduct.nom }} - Qté: {{ currentQuantityInput || '0' }}
    </div> -->

    <!-- Client et facture -->
    <div class="client_facture" style="padding-top: 5px;">
  <div class="double_client_facture">
    <div class="paiement_btn btn_client" (click)="openListClientPopup()">
      
      <!-- Cas : aucun client sélectionné -->
      <p *ngIf="!selectedClient && !selectedEntreprise">
        <img src="assets/img/profil.png" alt="client" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
        Client
      </p>
      
      <!-- Cas : client particulier sélectionné -->
      <div *ngIf="selectedClient" class="selected-client-info">
        <span>{{ selectedClient.nomComplet || 'Client' }}</span>
      </div>
      
      <!-- Cas : entreprise cliente sélectionnée -->
      <div *ngIf="selectedEntreprise" class="selected-client-info">
        <span>{{ selectedEntreprise.nom || 'Entreprise' }}</span>
      </div>

      <!-- Bouton pour effacer la sélection -->
      <span *ngIf="selectedClient || selectedEntreprise" 
            class="clear-customer"
            (click)="clearCustomerSelection($event)">
        <i class="ri-close-line"></i>
      </span>
    </div>

    <div class="paiement_btn btn_facture">
      <p>Facture</p>
      <input type="checkbox">
    </div>
  </div>
</div>


    <!-- 3. Clavier numérique + actions -->
    <div class="keypad">
      <button tabindex="-1" (click)="handleKeyPress('1'); notifyUserTyping()">1</button>
      <button tabindex="-1" (click)="handleKeyPress('2'); notifyUserTyping()">2</button>
      <button tabindex="-1" (click)="handleKeyPress('3'); notifyUserTyping()">3</button>
      <!-- <button tabindex="-1" class="btn_keypad_action btn_keypad_active">Qté</button> -->
      <!-- <button tabindex="-1" class="btn_keypad_action btn_keypad_active" (click)="activateQuantityMode()">Qté</button> -->
      <button [class.btn_keypad_active]="inputMode === 'quantity'" 
          (click)="setInputMode('quantity')">
    Qté
  </button>
      
      <button tabindex="-1" (click)="handleKeyPress('4'); notifyUserTyping()">4</button>
      <button tabindex="-1" (click)="handleKeyPress('5'); notifyUserTyping()">5</button>
      <button tabindex="-1" (click)="handleKeyPress('6'); notifyUserTyping()">6</button>
      <button [class.btn_keypad_active]="inputMode === 'discount'" 
          (click)="setInputMode('discount')">
    Remise
  </button>
      
      <button tabindex="-1" (click)="handleKeyPress('7'); notifyUserTyping()">7</button>
      <button tabindex="-1" (click)="handleKeyPress('8'); notifyUserTyping()">8</button>
      <button tabindex="-1" (click)="handleKeyPress('9'); notifyUserTyping()">9</button>
      <button tabindex="-1" class="btn_keypad_action">Prix</button>
      
      <button tabindex="-1" (click)="handleKeyPress('+/-'); notifyUserTyping()">+/-</button>
      <button tabindex="-1" (click)="handleKeyPress('0'); notifyUserTyping()">0</button>
      <button tabindex="-1" (click)="handleKeyPress(','); notifyUserTyping()">,</button>
      <button tabindex="-1" class="backspace" (click)="handleKeyPress('backspace')">
        <i class="ri-delete-back-2-line"></i>
      </button>
    </div>

    <!-- 4. Bouton de paiement -->
    <div class="btn_content">
      <button class="btn-payment" (click)="openPaymentPopup()">Paiement</button>
    </div>
  </div>
</div>

<!-- Popup de paiement -->
<div *ngIf="showPaymentPopup" class="payment-popup-overlay">
  <div class="payment-popup" [ngStyle]="{ 'transform': 'translate3d(' + popupOffset.x + 'px, ' + popupOffset.y + 'px, 0)' }" (click)="$event.stopPropagation()">
    <div class="popup-header" (mousedown)="startDrag($event)">
      <button (click)="closePaymentPopup()" class="close-btn">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <div class="section_popup_paiement">
      <div class="cadre_section_contenu_left_prise">
        <div class="section_contenu_left_prise">

          <!-- 1. Montant du paiement -->
          <div class="montant_paiement">
            <h1>{{ getTotalCart() | cfaCurrency }}</h1>
            <span>CFA</span>
            
            <!-- Afficher le montant original si remise -->
            <div *ngIf="getTotalDiscount() > 0 || globalDiscount.active" 
                class="original-price">
              {{ getSubtotal() | cfaCurrency }}
            </div>
          </div>

          <!-- 2. Moyens de paiement -->
          <div class="moyen_paiement_price">
            <div class="moyen_paiement">
              <p>{{ selectedPaymentMethod }}</p>
            </div>
            <div class="moyen_prise_du">
              <div class="price_du">
                <p>{{ paymentAmount | cfaCurrency }}</p>
                <i class="ri-close-line clear-icon" (click)="enteredAmount = ''; calculatePayment()"></i>
              </div>
            </div>
          </div>

          <div class="paiement_restant">
            <div class="moyen_paiement_restant">
              <p [style.color]="paymentAmount >= totalAmount ? '#008000' : '#ff0000'">
                {{ paymentAmount >= totalAmount ? 'Monnaie' : 'Restant' }}
              </p>
            </div>
            <div class="moyen_prise_du">
              <div class="price_du">
                <p [style.color]="paymentAmount >= totalAmount ? '#008000' : '#ff0000'">
                  {{ changeDue | cfaCurrency }}
                </p>
              </div>
            </div>
          </div>

          <!-- 3. Remise par produit -->
          <div class="summary_panel">
            <div class="double_row" *ngIf="getTotalDiscount() > 0">
              <span>Remise(s) produit</span>
              <span>-{{ getTotalDiscount() | cfaCurrency }}</span>
            </div>
            
            <!-- Nouveau: Champ remise globale -->
            <!-- <div class="discount-input">
              <div class="double_row">
                <span>Remise globale</span>
                <div class="discount-input">
                  <button class="btn-currency" 
                          [class.active]="globalDiscount.type === 'CFA'"
                          (click)="setGlobalDiscountType('CFA')">
                    CFA
                  </button>
                  <input type="number" placeholder="0" 
                        class="input-discount"
                        [(ngModel)]="globalDiscount.value"
                        (input)="onGlobalDiscountInputChange()"
                        min="0">
                  <button class="btn-percent" 
                          [class.active]="globalDiscount.type === '%'"
                          (click)="setGlobalDiscountType('%')">
                    %
                  </button>
                </div>
              </div>
            </div> -->

              <div>
                <div class="discount-input" *ngIf="globalDiscount.active">
                  <button class="btn-currency" 
                          [class.active]="globalDiscount.type === 'CFA'"
                          (click)="setGlobalDiscountType('CFA')">
                    CFA
                  </button>
                  <input type="number" placeholder="0" 
                        class="input-discount"
                        [(ngModel)]="globalDiscount.value"
                        (input)="onGlobalDiscountInputChange()"
                        min="0">
                  <button class="btn-percent" 
                          [class.active]="globalDiscount.type === '%'"
                          (click)="setGlobalDiscountType('%')">
                    %
                  </button>
              </div>
                <!-- <p style="padding: 10px 10px 5px; text-align: center;">Remise globale</p> -->
            </div>

            <div class="double_row total">
              <strong>Total</strong>
              <strong>{{ getTotalCart() | cfaCurrency }}</strong>
            </div>
          </div>

          <div class="discount-label">
            <p>Remise sur produit</p>
          </div>

        </div>
      </div>

      <div class="section_contenu_right" style="background-color: #ffffff; height: 80vh; box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;">
        <div class="list_produit_select">
          <!-- Moyens de paiement avec sélection -->
          <div class="methode_paiement">
            <div class="cadre_paiement" 
                [class.selected_mode_pay]="selectedPaymentMethod === 'Espèces'"
                (click)="selectPaymentMethod('Espèces')">
              <div class="img_paiement">
                <img src="assets/img/payer.png" alt="">
              </div>
              <div class="title_paiement">
                <p>Espèces</p>
              </div>
            </div>
            
            <div class="cadre_paiement" 
                [class.selected_mode_pay]="selectedPaymentMethod === 'mobile'"
                (click)="selectPaymentMethod('Mobile money')">
              <div class="img_paiement img_paiement_mobile">
                <img src="assets/img/money.png" alt="">
              </div>
              <div class="title_paiement">
                <p>Mobile money</p>
              </div>
            </div>
            
            <div class="cadre_paiement" 
                [class.selected_mode_pay]="selectedPaymentMethod === 'card'"
                (click)="selectPaymentMethod('Carte')">
              <div class="img_paiement img_paiement_carte">
                <img src="assets/img/carte-de-credit.png" alt="">
              </div>
              <div class="title_paiement">
                <p>Carte</p>
              </div>
            </div>
            
            <div class="cadre_paiement" 
                [class.selected_mode_pay]="selectedPaymentMethod === 'account'"
                (click)="selectPaymentMethod('Compte client')">
              <div class="img_paiement img_paiement_compte">
                <img src="assets/img/compte-rendu.png" alt="">
              </div>
              <div class="title_paiement">
                <p>Compte client</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 2. Récapitulatif : Client et facture -->
        <div class="client_facture">
          <div class="double_client_facture">
            <div class="paiement_btn btn_client" (click)="openListClientPopup()">
              <p *ngIf="!selectedClient && !selectedEntreprise">Client</p>
              
              <div *ngIf="selectedClient" class="selected-client-info">
                <span>{{ selectedClient.nomComplet || 'Client' }}</span>
              </div>
              
              <div *ngIf="selectedEntreprise" class="selected-client-info">
                <span>{{ selectedEntreprise.nom || 'Entreprise' }}</span>
              </div>

              <span *ngIf="selectedClient || selectedEntreprise" 
                    class="clear-customer"
                    (click)="clearCustomerSelection($event)">
                <i class="ri-close-line"></i>
              </span>
            </div>

            <!-- <div class="double_remise_facture container_facture"> -->
              <button style="border: none;" [class.global-active]="globalDiscount.active"
                    class="paiement_btn remise_produit"
                    (click)="toggleGlobalDiscount()">
                {{ globalDiscount.active ? 'Annuler Globale' : 'Remise Globale' }}
              </button>
              <!-- <div class="paiement_btn btn_facture">
                <p>Facture</p>
                <input type="checkbox">
              </div>
            </div> -->
            
          </div>
        </div>

        <!-- Clavier numérique -->
        <div class="keypad" style="padding-top: 5px;">
          <button tabindex="-1" (click)="handlePaymentKeyPress('1'); notifyUserTyping()">1</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('2'); notifyUserTyping()">2</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('3'); notifyUserTyping()">3</button>
          <button>Qté</button>
          
          <button tabindex="-1" (click)="handlePaymentKeyPress('4'); notifyUserTyping()">4</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('5'); notifyUserTyping()">5</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('6'); notifyUserTyping()">6</button>
          <button>%</button>
          
          <button tabindex="-1" (click)="handlePaymentKeyPress('7'); notifyUserTyping()">7</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('8'); notifyUserTyping()">8</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('9'); notifyUserTyping()">9</button>
          <button>Prix</button>
          
          <button tabindex="-1" (click)="handlePaymentKeyPress('+/-'); notifyUserTyping()">+/-</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress('0'); notifyUserTyping()">0</button>
          <button tabindex="-1" (click)="handlePaymentKeyPress(','); notifyUserTyping()">,</button>
          <button tabindex="-1" class="backspace" (click)="handlePaymentKeyPress('backspace')">
            <i class="ri-delete-back-2-line"></i>
          </button>
        </div>

        <!-- 4. Bouton de paiement -->
        <div class="btn_content">
          <button class="btn-payment-pop"
                  [disabled]="!isAmountEntered || isSubmittingVente"
                  (click)="completePayment()">
            <span *ngIf="!isSubmittingVente">Valider Paiement</span>
            <span *ngIf="isSubmittingVente">En cours…</span>
          </button>

        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- Popup de détail produit -->
<div *ngIf="showDetailPopup" class="detail-popup-overlay">
  <div class="detail-popup" [ngStyle]="{ 'transform': 'translate3d(' + popupOffset.x + 'px, ' + popupOffset.y + 'px, 0)' }" (click)="$event.stopPropagation()">
    <!-- En-tête -->
    <div class="popup-header" *ngIf="showDetailPopup && selectedProductForDetail" (mousedown)="startDrag($event)">
      <h3>Information [{{ selectedProductForDetail.codeGenerique }}]</h3>
      <button (click)="closeDetailPopup()" class="close-btn">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <!-- Corps principal -->
    <div class="popup-body" *ngIf="showDetailPopup && selectedProductForDetail">
      <!-- Titre de la boutique -->
      <!-- <h4 class="shop-name">Ma Boutique Orix</h4> -->


        <!-- Colonne gauche : image -->
        <div class="detail-image">
          <img
            [src]="selectedProductForDetail ? getProductImage(selectedProductForDetail.photo) : ''"
            alt="Image produit"
          />
        </div>

      <!-- Colonne droite : infos produit -->
          <div class="detail-info">
            <div class="detail_info_left">
              <div class="info-row">
              <span class="label">Nom produit</span>
              <span class="value">{{ selectedProductForDetail.nom }}</span>
            </div>
            <div class="info-row">
              <span class="label">Prix de vente</span>
              <span class="value">{{ selectedProductForDetail.prixVente | number }} CFA</span>
            </div>
            <div class="info-row">
              <span class="label">Catégorie</span>
               <span class="value">{{ selectedProductForDetail.nomCategorie }}</span>
            </div>
            <div class="info-row">
              <span class="label">Unité de mesure</span>
              <span class="value">{{ selectedProductForDetail.nomUnite }}</span>
            </div>

            <div class="info-row" *ngIf="selectedProductForDetail.datePreemption">
            <span class="label">Date d'expiration</span>
            <span 
              class="value" 
              [ngClass]="{'date-red': isNearExpiry(selectedProductForDetail.datePreemption)}">
              {{ formatDate(selectedProductForDetail.datePreemption || '') }}
            </span>
          </div>

          </div>
          <div class="detail_info_right">

           <div class="info-row">
              <span class="label">Stocks actuel</span>
              <span class="value" [ngClass]="getQuantiteClass(selectedProductForDetail)">
                {{ getQuantiteDansBoutiqueCourante(selectedProductForDetail) }}
                <ng-container *ngIf="isQuantiteCritique(selectedProductForDetail)">⚠️</ng-container>
              </span>
           </div>

            <div class="info-row">
              <span class="label">Boutique</span>
              <span class="value">{{ getNomBoutiqueCourante(selectedProductForDetail) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Code</span>
              <span class="value">{{ selectedProductForDetail.codeGenerique }}</span>
            </div>

            <div class="info-row" *ngIf="selectedProductForDetail.codeBare">
              <span class="label">Code barre</span>
              <span class="value">
                <ngx-barcode6
                  class="barcode-shifted"
                  [bc-value]="selectedProductForDetail.codeBare"
                  bc-format="CODE128"
                  [bc-line-color]="'#000000'"
                  [bc-width]="1"
                  [bc-height]="30"
                  [bc-font-size]="10"
                  [bc-display-value]="true">
                </ngx-barcode6>
              </span>
            </div>

          </div>
        </div>

      <!-- Description en bas -->
      <div class="detail-description">
        <span class="label">Description:</span> <br>
        {{ selectedProductForDetail.description || 'Pas de description' }}
      </div>
    </div>

    <!-- Pied de popup -->
    <div class="popup-actions">
      <button class="btn-add" (click)="addToCart(selectedProductForDetail!); closeDetailPopup();">
        Ajouter au panier
      </button>
    </div>
  </div>
</div>

<!-- Popup de client -->
<div *ngIf="showClientPopup" class="list-client-popup-overlay">
  <div class="list-client-popup" [ngStyle]="{ 'transform': 'translate3d(' + popupOffset.x + 'px, ' + popupOffset.y + 'px, 0)' }" (click)="$event.stopPropagation()">
    <div class="popup-header" (mousedown)="startDrag($event)">

    <h6 class="title" style="margin-bottom: 0; font-size: 16px; letter-spacing: 0.65px;">
      {{ currentListTypePopup === 'clients' ? 'Client individuel' : 'Client entreprise' }}
    </h6>

      <!-- Barre de recherche -->
      <div class="double" style="gap: 10px;">

        <div class="btnAddClient" *ngIf="canAddClient">
          <button (click)="openAddClient()">
            Ajouter Client
          </button>
        </div>

        <div class="barre" *ngIf="canAddClient"></div>

        <!-- Compteur Clients Individuels -->
        <div class="contentIcon" 
            [class.active]="currentListTypePopup === 'clients'"
            (click)="setListTypePopup('clients')">
          <i class="ri-folder-user-line"></i>
          <div class="nombreCount">
            <span>{{ clients.length }}</span>
          </div>
        </div>

        <div class="barre"></div>

        <!-- Compteur Entreprises -->
        <div class="contentIcon" 
            [class.active]="currentListTypePopup === 'entreprises'"
            (click)="setListTypePopup('entreprises')">
          <i class="ri-building-line"></i>
          <div class="nombreCount">
            <span>{{ entreprisesPopup.length }}</span>
          </div>
        </div>

        <div class="barre"></div>

        <div class="inputSearch">
          <i class="ri-search-2-line"></i>
          <input type="text" placeholder="Recherche un client" [(ngModel)]="searchText"/>
        </div>

        <button (click)="closeListClientPopup()" class="close-btn">
          <i class="ri-close-line"></i>
        </button>
      </div>
    </div>

    <!-- Tableau -->
    <table *ngIf="currentListTypePopup === 'clients'">
      <thead>
        <!-- <th>Photo</th>
        <th (click)="sort('nomComplet')">
          Nom & prénom 
          <i [class]="sortField === 'nomComplet' ? (sortDirection === 'asc' ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line') : 'ri-arrow-up-down-line'"></i>
        </th>
        <th> Email </th>
        <th> Adresse </th>
        <th> Téléphone </th>
        <th> Entreprise </th>
        <th> Date de Creation </th>
      </thead> -->
      <tbody>
          <tr *ngFor="let client of filteredClients" (click)="selectClient(client)">
              <td>
                <div class="imgClient">
                  <img [src]="client.photo" alt="Photo client">
                </div>
              </td>
              <td>
                <span *ngIf="client.nomComplet; else noNomComplet" 
                      [innerHTML]="highlightMatch(client.nomComplet)"></span>
                <ng-template #noNomComplet>
                  <span class="no-phone-text">Nom est vide</span>
                </ng-template>
              </td>
              <td>
                <span *ngIf="client.email; else noEmail" [innerHTML]="highlightMatch(client.email)">{{ client.email }}</span>
                <ng-template #noEmail>
                  <span class="no-phone-text">Non email</span>
                </ng-template>
              </td>
              <td>
                <span *ngIf="client.adresse; else noAdresse">{{ client.adresse }}</span>
                <ng-template #noAdresse>
                  <span class="no-phone-text">Non adresse</span>
                </ng-template>
              </td>
              <td>
                <span *ngIf="client.telephone; else noPhone">{{ client.telephone }}</span>
                <ng-template #noPhone>
                  <span class="no-phone-text">Non numéro de téléphone</span>
                </ng-template>
              </td>
              <td>
                <div *ngIf="client.entrepriseClient; else noEntreprise" class="iconEntrepriseList">
                  <i class="ri-git-branch-fill" title="Affiliation d'Entreprise"></i>
                </div>
                <ng-template #noEntreprise>
                  <!-- Vide si pas d'entreprise -->
                </ng-template>
              </td>
              <td>
                <span *ngIf="client.createdAt; else noDate">{{ client.createdAt | date: 'dd/MM/yyyy' }}</span>
                <ng-template #noDate>
                  <span class="no-phone-text">Non date</span>
                </ng-template>
          </tr>
          <tr *ngIf="filteredClients.length === 0">
            <td colspan="7" class="no-client-message">Aucun client trouvé</td>
          </tr>
      </tbody>
    </table>

    <!-- Tableau pour Entreprises -->
    <table *ngIf="currentListTypePopup === 'entreprises'">
      <tbody>
        <tr *ngFor="let entreprise of filteredEntreprisesPopup" (click)="selectEntreprise(entreprise)">
         <td>
          <div class="imgClient">
            <img src="assets/img/office_building.png" alt="Logo entreprise">
          </div>
        </td>
        <td>
          <span *ngIf="entreprise.nom; else noNom" [innerHTML]="highlightMatch(entreprise.nom)">{{ entreprise.nom }}</span>
          <ng-template #noNom>
            <span class="no-phone-text">Nom vide</span>
          </ng-template>
        </td>
        <td>
          <span *ngIf="entreprise.email; else noEmail" [innerHTML]="highlightMatch(entreprise.email)">{{ entreprise.email }}</span>
          <ng-template #noEmail>
            <span class="no-phone-text">Non email</span>
          </ng-template>
        </td>
        <td>
          <span *ngIf="entreprise.adresse; else noAdresse">{{ entreprise.adresse }}</span>
          <ng-template #noAdresse>
            <span class="no-phone-text">Non adresse</span>
          </ng-template>
        </td>
        <td>
          <span *ngIf="entreprise.telephone; else noPhone">{{ entreprise.telephone }}</span>
          <ng-template #noPhone>
            <span class="no-phone-text">Non téléphone</span>
          </ng-template>
        </td>
        <td>{{ entreprise.pays || '--' }}</td>
        <td>{{ entreprise.siege || '--' }}</td>
        <td>{{ entreprise.secteur || '--' }}</td>
        <td>
          <span *ngIf="entreprise.createdAt; else noDate">{{ entreprise.createdAt | date: 'dd/MM/yyyy' }}</span>
          <ng-template #noDate>
            <span class="no-phone-text">Non date</span>
          </ng-template>
        </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Popup d'ajout de client -->
<div *ngIf="showAddClientPopup" class="add-client-popup-overlay">
  <div class="add-client-popup" [ngStyle]="{ 'transform': 'translate3d(' + popupOffset.x + 'px, ' + popupOffset.y + 'px, 0)' }" (click)="$event.stopPropagation()">
    <div class="popup-header" (mousedown)="startDrag($event)">
      <h3>Ajouter un nouveau client</h3>
      <button (click)="closeAddClientPopup()" class="close-btn">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <div class="popup-body">
      <div class="add-client-form">
        <div class="form-group">
          <label>Type de client</label>
          <div class="client-type-selector">
            <button type="button" 
                    class="client-type-btn" 
                    [class.active]="clientType === 'individuel'"
                    (click)="setClientType('individuel')">
              Individuel
            </button>
            <button type="button" 
                    class="client-type-btn" 
                    [class.active]="clientType === 'entreprise'"
                    (click)="setClientType('entreprise')">
              Entreprise
            </button>
          </div>
        </div>

        <!-- Formulaire client individuel -->
        <form *ngIf="clientType === 'individuel'" [formGroup]="clientForm" class="add-client-form">
          <div class="double_input">
            <!-- Nom et prenom -->
            <div class="champ_input">
              <input type="text" class="input_focus"
                        id="nomComplet" formControlName="nomComplet"
                        name="nomComplet"
                        placeholder="Saisis le nom et prénom">
              <label for="nomComplet" class="label">Nom et prénom</label>
              <div *ngIf="clientForm.get('nomComplet')?.touched && clientForm.get('nomComplet')?.invalid" class="error">
                <small *ngIf="clientForm.get('nomComplet')?.errors?.['required']">Champ requis.</small>
                <small *ngIf="clientForm.get('nomComplet')?.errors?.['minlength']">Au moins 2 caractères.</small>
              </div>
            </div>
            <!-- Email -->
            <div class="champ_input">
              <input type="email" class="input_focus"
                        id="email" formControlName="email"
                        name="email"
                        placeholder="Saisis l'email">
              <label for="email" class="label">Email</label>
              <div *ngIf="clientForm.get('email')?.touched && clientForm.get('email')?.invalid" class="error">
                <small *ngIf="clientForm.get('email')?.errors?.['email']">Format invalide.</small>
              </div>
            </div>

          </div>
          <div class="double_input">
            <!-- Adresse -->
            <div class="champ_input">
              <input class="input_focus"
                        id="adresse" formControlName="adresse"
                        name="adresse"
                        placeholder="Saisis l'adresse">
              <label for="adresse" class="label">Adresse</label>
            </div>

            <!-- Poste -->
            <div class="champ_input">
              <input class="input_focus"
                        id="poste" formControlName="poste"
                        name="poste"
                        placeholder="Saisissez votre poste ">
              <label for="poste" class="label">Poste</label>
            </div>

          </div>

          <!-- Modifiez le sélecteur de pays et le champ téléphone -->
          <div class="grid_colonne">
            <!-- Pays -->
                <div class="champ_input div1">
          <select class="input_focus" formControlName="pays" (change)="onPaysChange($event)">
            <option value="" disabled selected>Pays</option>
            <option *ngFor="let nomPays of paysKeys" [value]="nomPays">
              {{ nomPays }} ({{ paysIndicatifs[nomPays].indicatif }})
            </option>
          </select>
          <label for="pays" class="label">Pays</label>
          <div *ngIf="clientForm.get('pays')?.invalid && clientForm.get('pays')?.touched" class="error">
            <small>Ce champ est requis</small>
          </div>
        </div>

            <!-- Téléphone -->
            <div class="champ_input div2">
              <input type="tel" class="input_focus"
                      id="telephone" formControlName="telephone"
                      name="telephone"
                      placeholder="Saisis le numéro de téléphone"
                      (input)="formatPhoneNumber()">
              <label for="telephone" class="label">Téléphone</label>
            
              <!-- Message d'erreur si pattern invalide -->
              <div *ngIf="
                    clientForm.get('telephone')?.touched &&
                    clientForm.get('telephone')?.errors?.['pattern'] &&
                    clientForm.get('pays')?.value as pays
                  " class="error">
                <small>
                  Le numéro doit contenir
                  {{ paysIndicatifs[pays].longueur }}
                  chiffres après l’indicatif {{ paysIndicatifs[pays].indicatif.trim() }}.
                </small>
              </div>
            
              <!-- Éventuellement, message pour champ requis -->
              <div *ngIf="
                    clientForm.get('telephone')?.touched &&
                    clientForm.get('telephone')?.errors?.['required']
                  " class="error">
                <small>Le téléphone est requis.</small>
              </div>
            </div>                    

            <!-- Ville -->
            <div class="champ_input div3">
              <input class="input_focus"
                        id="ville" formControlName="ville"
                        name="ville"
                        placeholder="Saisis la ville">
              <label for="ville" class="label">Ville</label>
            </div>
          </div>

          <div class="info_titre_input" style="margin-top: 20px;">
            <h5>Entreprise</h5>
        
            <!-- Input de produits inventaire -->
            <div class="champ_input_inventaire">
              <p>J'appartient à une entreprise</p>
        
              <label class="switch">
                <input type="checkbox" [(ngModel)]="isEntrepriseSelected" [ngModelOptions]="{standalone: true}"/>
                <span class="slider round"></span>
              </label>
            </div>
          </div>
          
          <!-- Autocomplete pour les entreprises -->
          <div *ngIf="isEntrepriseSelected" class="champ_input">
            <input type="text"
                  placeholder="Selectionner une entreprise"
                  [formControl]="control"
                  [matAutocomplete]="auto"
                  class="input_focus input_cursor">
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onEntrepriseSelected($event)" [displayWith]="displayFnEntreprise">
              <!-- <mat-option class="select-option" (click)="openAddEntreprisePopup()">
                <div style="display: flex; align-items: center; color: #0672E4;">
                  <i class="ri-community-line"></i>
                  <span style="margin-left: 8px;">Créer une entreprise</span>
                </div>
              </mat-option> -->
              <mat-option *ngFor="let ent of filteredOptions | async" [value]="ent">
                <div class="option-content">
                  {{ ent.nom }}
                </div>
              </mat-option>
            </mat-autocomplete>
          </div>
        </form>

        <!-- Formulaire client entreprise -->
        <form *ngIf="clientType === 'entreprise'" [formGroup]="entrepriseForm" class="add-client-form">
          <div class="double_input">
            <div class="champ_input">
              <input type="text" class="input_focus"
                    id="nom" formControlName="nom"
                    name="nom"
                    placeholder="Saisis le nom d'entreprise">
              <label for="nom" class="label">Nom d'entreprise</label>
              <div *ngIf="entrepriseForm.get('nom')?.touched && entrepriseForm.get('nom')?.invalid" class="error">
                <small *ngIf="entrepriseForm.get('nom')?.errors?.['required']">Champ requis.</small>
                <small *ngIf="entrepriseForm.get('nom')?.errors?.['minlength']">Au moins 2 caractères.</small>
              </div>
            </div>
            <div class="champ_input">
              <input type="email" class="input_focus"
                    id="email" formControlName="email"
                    name="email"
                    placeholder="Saisis l'email">
              <label for="email" class="label">Email</label>
              <div *ngIf="entrepriseForm.get('email')?.touched && entrepriseForm.get('email')?.invalid" class="error">
                <small *ngIf="entrepriseForm.get('email')?.errors?.['email']">Format invalide.</small>
              </div>
            </div>
          </div>

          <div class="double_input">
            <div class="champ_input">
              <input class="input_focus"
                    id="adresse" formControlName="adresse"
                    name="adresse"
                    placeholder="Saisis l'adresse">
              <label for="adresse" class="label">Adresse</label>
            </div>
            <div class="champ_input">
              <input class="input_focus"
                    id="siege" formControlName="siege"
                    name="siege"
                    placeholder="Saisis le siège">
              <label for="siege" class="label">Siège</label>
            </div>
          </div>

          <div class="grid_colonne">
            <div class="champ_input div1">
              <select class="input_focus" formControlName="pays" (change)="onEntreprisePaysChange($event)">
                <option value="" disabled selected>Pays</option>
                <option *ngFor="let nomPays of paysKeys" [value]="nomPays">
                  {{ nomPays }} ({{ paysIndicatifs[nomPays].indicatif }})
                </option>
              </select>
              <label for="pays" class="label">Pays</label>
            </div>

            <div class="champ_input div2">
              <input type="tel" class="input_focus"
                    id="telephone" formControlName="telephone"
                    name="telephone"
                    placeholder="Saisis le numéro de téléphone"
                    (input)="formatEntreprisePhoneNumber()">
              <label for="telephone" class="label">Téléphone</label>
            
              <div *ngIf="
                    entrepriseForm.get('telephone')?.touched &&
                    entrepriseForm.get('telephone')?.errors?.['pattern'] &&
                    entrepriseForm.get('pays')?.value as pays
                  " class="error">
                <small>
                  Le numéro doit contenir
                  {{ paysIndicatifs[pays].longueur }}
                  chiffres après l'indicatif {{ paysIndicatifs[pays].indicatif.trim() }}.
                </small>
              </div>
            
              <div *ngIf="
                    entrepriseForm.get('telephone')?.touched &&
                    entrepriseForm.get('telephone')?.errors?.['required']
                  " class="error">
                <small>Le téléphone est requis.</small>
              </div>
            </div>

            <div class="champ_input div3">
              <input class="input_focus"
                    id="secteur" formControlName="secteur"
                    name="secteur"
                    placeholder="Saisis le secteur">
              <label for="secteur" class="label">Secteur</label>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="popup-actions">
      <button class="btn-cancel" (click)="closeAddClientPopup()">Annuler</button>
      <button class="btn-save" 
              (click)="clientType === 'individuel' ? ajouterClientDansPopup() : ajouterEntrepriseDansPopup()"
              [disabled]="clientType === 'individuel' ? clientForm.invalid : entrepriseForm.invalid"
              [style.backgroundColor]="(clientType === 'individuel' ? clientForm.valid : entrepriseForm.valid) ? '#0672E4' : '#0671e434'"
              [style.color]="(clientType === 'individuel' ? clientForm.valid : entrepriseForm.valid) ? '#ffffff' : '#00000073'"
              [style.cursor]="(clientType === 'individuel' ? clientForm.valid : entrepriseForm.valid) ? 'pointer' : 'no-drop'">
        Enregistrer
      </button>
    </div>
  </div>
</div>

<div class="scan-error-toast" *ngIf="showScanError">
  <i class="ri-error-warning-line"></i>
  <span>{{ scanErrorMessage }}</span>
</div>