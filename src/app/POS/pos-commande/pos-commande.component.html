
<div class="section_contenu_container">
    <!-- // section contenu left -->
    <div class="section_contenu_left">
        <!-- // section favory produit -->
        <div class="section_commande">
            <!-- // section recherche  -->
                <!-- toolbar avec template ref pour l'input -->
            <div class="toolbar" appClickOutside (clickOutside)="closeFilterDropdown()">
                <div class="icon_search">
                    <i class="ri-search-line"></i>
                </div>

                <div class="search">
                    <!-- utilisation de #searchInput pour éviter l'erreur TS -->
                    <input #searchInput type="text" placeholder="Rechercher des commandes..." (input)="onSearch(searchInput.value)" />
                </div>

                <div class="btn_search_filtre">
                    <button class="btn" (click)="toggleFilterDropdown()">
                      {{ currentFilterLabel }} <i class="ri-arrow-down-s-fill"></i>
                    </button>

                    <ul *ngIf="showFilterDropdown" class="dropdown_filter">
                      <li *ngFor="let opt of filterOptions" (click)="selectFilter(opt.key)">
                          {{ opt.label }}
                      </li>
                    </ul>
                </div>
            </div>

            <!-- Section liste des commandes / ventes -->
            <div class="section_list_commande">
            <!-- Si on est en mode "en-cours" on affiche les commandes locales -->
            <ng-container *ngIf="currentFilterKey === 'en-cours'">
                <ul *ngFor="let commande of commandes" class="ul_commande"
                    [class.ul_commande_active]="activeCommandeId === commande.id"
                    (click)="setActiveCommande(commande.id)">
                <li class="li_commande">
                    <div class="commande_date_heure">
                    <p class="commande_date">{{ commande.createdAt | date:'dd/MM/yyyy' }}</p>
                    <p class="commande_heure">{{ commande.createdAt | date:'HH:mm' }}</p>
                    </div>
                </li>
                <li class="li_commande">
                    <div class="num_onglet_commande"><p>{{ commande.id }}</p></div>
                </li>
                <li class="li_commande">
                    <div class="quantite_commande"><p>Quantité {{ commande.totalItems }}</p></div>
                </li>
                <li class="li_commande">
                    <div class="price_commande"><p>{{ commande.totalAmount | cfaCurrency }}</p></div>
                </li>
                <li class="li_commande" style="display:flex;align-items:center;gap:30px;">
                    <div class="etat_commande"><p>En cours</p></div>
                </li>
                </ul>

                <div *ngIf="!commandes.length" class="loading_commande">
                Pas de commandes en cours
                </div>
            </ng-container>

            <!-- Si on est en mode ventes (payer/terminee/annuler), on affiche les ventes -->
            <ng-container *ngIf="currentFilterKey !== 'en-cours'">
                <ul *ngFor="let vente of ventes" class="ul_commande"
                    [class.ul_commande_active]="activeVenteId === vente.venteId"
                    (click)="setActiveVente(vente.venteId)">
                <li class="li_commande">
                    <div class="commande_date_heure">
                    <p class="commande_date">{{ vente.dateVente | date:'dd/MM/yyyy' }}</p>
                    <p class="commande_heure">{{ vente.dateVente | date:'HH:mm' }}</p>
                    </div>
                </li>
                <li class="li_commande">
                    <div class="num_onglet_commande"><p>{{ vente.venteId }}</p></div>
                </li>
                <li class="li_commande">
                    <div class="quantite_commande"><p>Quantité {{ getTotalItems(vente) }}</p></div>
                </li>
                <li class="li_commande">
                    <div class="price_commande"><p>{{ vente.montantTotal | cfaCurrency }}</p></div>
                </li>
                <li class="li_commande" style="display:flex;align-items:center;gap:30px;">
                    <div class="etat_commande">
                        <p [class.status-paid]="getVenteStatus(vente) === 'Payer'">
                            {{ getVenteStatus(vente) }}
                        </p>
                    </div>
                </li>
                </ul>

                <div *ngIf="!ventes.length" class="loading_commande">
                Pas de ventes pour ce filtre
                </div>
            </ng-container>
            </div>
        </div>
    </div>
    <!-- // section contenu right -->
    <div class="section_contenu_right" style="background-color: #ffffff; height: 100vh; box-shadow: rgba(0, 0, 0, 0.04) 0px 3px 5px;">
        <div class="list_produit_select">

          <!-- Si on est sur "En cours" : montrer les produits de la commande locale active -->
          <ng-container *ngIf="currentFilterKey === 'en-cours'">
            <ul class="ul_list_produit_select">
              <li class="li_list_produit_select" *ngFor="let item of activeCommandeItems">
                <div class="double_commande">
                  <div class="nombre_select">{{ item.quantity }}</div>
                  <div class="name_produit_select">
                    <p style="margin:0;">
                      {{ item.product.nom }}
                      <span>({{ item.product.prixVente | cfaCurrency }})</span>
                    </p>
                  </div>
                </div>
                <div class="double_commande">
                  <div class="price_produit">
                    {{ (item.quantity * item.product.prixVente) | cfaCurrency }}
                  </div>
                </div>
              </li>
            </ul>

            <div *ngIf="activeCommandeItems.length === 0" class="empty-cart-message">
              <p>Aucun produit dans cette commande</p>
            </div>
          </ng-container>

          <!-- Sinon : afficher les produits de la vente (backend) -->
          <ng-container *ngIf="currentFilterKey !== 'en-cours'">
            <ul class="ul_list_produit_select">
              <li class="li_list_produit_select" *ngFor="let item of activeVenteItems">
                <div class="double_commande">
                  <div class="nombre_select">{{ item.quantity }}</div>
                  <div class="name_produit_select">
                    <p style="margin:0;">
                      {{ item.product.nom }}
                      <span>({{ item.product.prixVente | cfaCurrency }})</span>
                    </p>
                  </div>
                </div>
                <div class="double_commande">
                  <div class="price_produit">
                    {{ (item.quantity * item.product.prixVente) | cfaCurrency }}
                  </div>
                </div>
                <div class="icon_check">
                  <label class="cyber-checkbox">
                    <input 
                        type="checkbox">
                        
                        <span class="cyber-checkbox__mark">
                          <div class="cyber-checkbox__box">
                              <svg class="cyber-checkbox__check" viewBox="0 0 12 10">
                              <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
                              </svg>
                          </div>
                          <div class="cyber-checkbox__effects">
                              <div class="cyber-checkbox__spark"></div>
                              <div class="cyber-checkbox__spark"></div>
                              <div class="cyber-checkbox__spark"></div>
                              <div class="cyber-checkbox__spark"></div>
                          </div>
                          <div class="cyber-checkbox__particles">
                              <div class="particle-1"></div>
                              <div class="particle-2"></div>
                              <div class="particle-3"></div>
                              <div class="particle-4"></div>
                              <div class="particle-5"></div>
                              <div class="particle-6"></div>
                              <div class="particle-7"></div>
                              <div class="particle-8"></div>
                          </div>
                        </span>
                    </label>
                </div>
              </li>
            </ul>

            <div *ngIf="activeVenteItems.length === 0" class="empty-cart-message">
              <p>Aucun produit dans cette vente</p>
            </div>
          </ng-container>

        </div>

        <!-- Récapitulatif : Taxes / Total -->
        <div class="summary_panel">
            <div class="double_row">
                <span>Taxes</span>
                <span>00 CFA</span>
            </div>
            <div class="double_row total">
                <strong>Total</strong>
                <strong>{{ activeVente?.montantTotal | cfaCurrency }}</strong>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="btn_container">
            <!-- Bouton retour -->
            <div class="btn_action_commande">
                <button class="btn_retourn" (click)="router.navigate(['/pos-accueil'])">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
            </div>
            
            <!-- Bouton paiement -->
            <div class="btn_content">
              <button class="btn-payment" (click)="openCancelPopup()">Annuler la commande</button>
            </div>
            
            <!-- Bouton supprimer la commande -->
            <div class="btn_action_commande">
                <button class="btn_delete" (click)="removeCommande(activeCommandeId)">
                    <i class="ri-delete-bin-5-line"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ajoutez ceci à la fin de votre template -->
<div *ngIf="showCancelPopup" class="popup-overlay">
  <div class="popup">

    <!-- Bouton de fermeture en haut à droite -->
    <button class="close-btn" (click)="closeCancelPopup()">
      <i class="ri-close-line"></i>
    </button>

    <h2>Confirmation d'annulation</h2>
    <p>Veuillez entrer le Code PIN pour annuler la commande.</p>
    
    <div class="pin-container" [class.shake]="isCodeWrong">
      <input type="password" maxlength="1" [(ngModel)]="pin[0]" #pin0 id="0"
             (input)="goToNext(pin0, pin1)" 
             (keydown)="handleBackspace($event, 0, pin0, pin1)" />

      <input type="password" maxlength="1" [(ngModel)]="pin[1]" #pin1 id="1"
             (input)="goToNext(pin1, pin2)" 
             (keydown)="handleBackspace($event, 1, pin1, pin0)" />

      <input type="password" maxlength="1" [(ngModel)]="pin[2]" #pin2 id="2"
             (input)="goToNext(pin2, pin3)" 
             (keydown)="handleBackspace($event, 2, pin2, pin1)" />

      <input type="password" maxlength="1" [(ngModel)]="pin[3]" #pin3 id="3"
             (input)="verifyCode()" 
             (keydown)="handleBackspace($event, 3, pin3, pin2)" />
    </div>
    <button (click)="verifyCode()">Valider</button>
  </div>
</div>