<!-- pos-accueil.component.html -->
<div class="pos_container">
  <div class="pos_content">
    <!-- // DEBUT DE HEADER  -->
    <div class="pos_header">
      <nav class="navBar">
        <!-- // COTE LEFT  -->
        <div class="header_left">
          <!-- // btn vente pos  -->
          <div class="btn_vente_pos" (click)="onClickVente()">
            <button class="btn btn_default" [class.btn_active]="activeButton === 'vente'">
              Ventes POS
            </button>
          </div>
          <!-- // btn commande pos  -->
          <div class="btn_commande_pos" (click)="onClickCommandes()">
            <button class="btn btn_default" [class.btn_active]="activeButton === 'commande'">
              Commandes
            </button>
          </div>
          <!-- // btn add commande  -->
          <div class="btn_add_commande">
            <button class="btn" (click)="addCommande()">
              <i class="ri-add-line"></i>
            </button>
          </div>
          <!-- // List des commande en onglet  -->
          <ul class="list_commande">
            <li *ngFor="let cmd of visibleCommandes" 
                [class.list_commande_active]="activeCommande === cmd"
                (click)="setActiveCommande(cmd)">
              {{ cmd }}
            </li>
            
            <li *ngIf="commandes.length > 6" 
                class="list_commande_plus" 
                (click)="showCommandePopup = true">
              <i class="ri-arrow-down-s-line"></i>
            </li>
          </ul>

          <!-- Popup au centre de l'écran -->
          <div *ngIf="showCommandePopup" class="commande-popup-overlay">
            <div class="commande-popup-content" 
                [ngStyle]="{ 'transform': 'translate3d(' + popupOffsetPopup.x + 'px, ' + popupOffsetPopup.y + 'px, 0)' }" (click)="$event.stopPropagation()">
              <!-- Déplacer l'événement startDragPopup uniquement sur le header -->
              <div class="popup-header" (mousedown)="startDragPopup($event)">
                <h3>Liste des commandes</h3>
                <i class="ri-close-line" (click)="closePopup($event)"></i>
              </div>
              <div class="popup-commandes">
                <ul class="list_commande commandes-grid">
                  <li *ngFor="let cmd of commandes" 
                      [class.active]="activeCommande === cmd"
                      (click)="setActiveCommande(cmd)">
                    {{ cmd }}
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- // COTE RIGHT  -->
        <div class="header_right">
          <!-- // Name boutique  -->
          <div class="name_boutique">
            <!-- Affiche le nom seulement une fois chargé ; sinon mini loader / rien -->
            <ng-container *ngIf="isBoutiqueNameLoaded; else loadingBoutique">
              <p>{{ selectedBoutiqueName }}</p>
            </ng-container>

            <ng-template #loadingBoutique>
              <!-- tu peux afficher rien, un placeholder ou un petit spinner -->
              <!-- Exemple : un petit texte discret -->
              <p class="boutique-loading">...</p>
            </ng-template>
          </div>

          <!-- // Input de recherche  -->
          <div class="inputSearch">
            <i class="ri-search-2-line"></i>
            <input 
              type="text" placeholder="Recherche des produits"/>
          </div>
          <!-- // Icon de sort -->
          <!-- <div class="icon_sort">
            <i class="ri-sort-asc"></i>
          </div> -->
          <div class="icon_sort" (click)="showDropdown = !showDropdown" clickOutside (clickOutside)="showDropdown = false">
            <i [class]="(isListView$ | async) ? 'ri-apps-fill' : 'ri-list-check'"></i>
            
            <div class="view-dropdown" *ngIf="showDropdown">
              <div class="dropdown-item" (click)="toggleView('grid')">
                Cadre {{ (isListView$ | async) ? '✓' : '' }}
              </div>
              <div class="dropdown-item" (click)="toggleView('list')">
                Liste {{ !(isListView$ | async) ? '✓' : '' }}
              </div>
            </div>
          </div>
          <!-- // profil  -->
          <div class="profil">
            <span>{{ userName }}</span>
          </div>
          <!-- // Menu  -->
          <div class="menu" 
              (click)="toggleMenuDropdown()" 
              clickOutside 
              (clickOutside)="showMenuDropdown = false">
            <i class="ri-menu-line"></i>
            
            <!-- Dropdown Menu -->
            <div class="menu-dropdown" *ngIf="showMenuDropdown">
              <div class="dropdown-item">
                <i class="ri-download-line"></i>
                Installer l'application
              </div>
              <div class="dropdown-item">
                <i class="ri-home-5-line"></i>
                Tableau de bord
              </div>
              <div class="dropdown-item">
                <i class="ri-restart-line"></i>
                Recharger les donnees
              </div>
              <div class="dropdown-item" (click)="prepareFermerCaisse()">
                <i class="ri-money-euro-circle-line"></i>
                Fermer la caisse
              </div> 
            </div>
          </div>
        </div>
      </nav>
    </div>
    <!-- // FIN DE HEADER  -->
    <!-- // DEBUT DE CONTENU  -->
    <router-outlet></router-outlet>

    <!-- // FIN DE CONTENU  -->
    

  </div>
</div>

<!-- Popup de fermeture de caisse -->
<div *ngIf="showFermerCaissePopup" class="commande-popup-overlay">
  <div class="commande-popup-content" [ngStyle]="{ 'transform': 'translate3d(' + popupOffsetPopup.x + 'px, ' + popupOffsetPopup.y + 'px, 0)' }" (click)="$event.stopPropagation()">
    <div class="popup-header" (mousedown)="startDragPopup($event)">
      <h3>Fermer la caisse</h3>
      <i class="ri-close-line" (click)="showFermerCaissePopup = false"></i>
    </div>
    
    <div class="popup-body">
      <!-- État de chargement -->
      <div *ngIf="isLoadingCaisseDetails" class="loading-indicator">
        <i class="ri-loader-4-line spin"></i> Chargement des détails...
      </div>
      
      <!-- Détails de la caisse -->
      <div *ngIf="caisseDetails && !isLoadingCaisseDetails" class="caisse-details-container">
        <div class="caisse-info-header">
          <div class="profil">
            <span>{{ caisseDetails.nomVendeur ? caisseDetails.nomVendeur[0] : '?' }}</span>
          </div>
          <div>
            <div class="caisse-info-title">{{ caisseDetails.nomVendeur || 'Vendeur non spécifié' }}</div>
            <div class="caisse-info-subtitle">{{ caisseDetails.nomBoutique || 'Boutique non spécifiée' }}</div>
          </div>
        </div>
        
        <div class="caisse-details-grid">
          <div class="detail-item">
            <span class="detail-label">Statut:</span>
            <span class="detail-value" [class.text-success-status]="caisseDetails.statut === 'OUVERTE'"
                                 [class.text-danger]="caisseDetails.statut === 'FERMEE'">
              {{ caisseDetails.statut === 'OUVERTE' ? 'Ouverte' : 'Fermée' }}
            </span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Montant initial :</span>
            <span class="detail-value">{{ caisseDetails.montantInitial | cfaCurrency }}</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Montant courant :</span>
            <span class="detail-value">{{ caisseDetails.montantCourant | cfaCurrency }}</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Ouverte le :</span>
            <span class="detail-value">{{ formatDate(caisseDetails.dateOuverture) }}</span>
          </div>
          
          <div class="detail-item" *ngIf="caisseDetails.dateFermeture">
            <span class="detail-label">Fermée le :</span>
            <span class="detail-value">{{ formatDate(caisseDetails.dateFermeture) }}</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Montant obtenu :</span>
            <span class="detail-value">{{ getMontantObtenu() | cfaCurrency }}</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Nom Vendeur :</span>
            <span class="detail-value">{{ caisseDetails.nomVendeur || 'N/A' }}</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Nom Boutique :</span>
            <span class="detail-value">{{ caisseDetails.nomBoutique || 'N/A' }}</span>
          </div>
        </div>
      </div>
      
      <!-- Messages d'erreur -->
      <div *ngIf="fermetureErrorMessage" class="error-message">
        <i class="ri-error-warning-line"></i> {{ fermetureErrorMessage }}
      </div>
    </div>
    
    <div class="popup-footer">
      <button class="btn btn-cancel" 
              (click)="showFermerCaissePopup = false"
              [disabled]="isLoadingCaisseDetails">
        Annuler
      </button>
      <button class="btn btn-confirm" 
              (click)="onLogout()"
              [disabled]="isLoadingCaisseDetails || !caisseDetails">
        Confirmer la fermeture
      </button>
    </div>
  </div>
</div>