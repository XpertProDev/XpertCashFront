<div class="container_pos_caisse">
    <div class="content_pos_caisse">

        <div class="titre_all_caisse" style="padding: 20px 20px 0; ">
            <h6>Ma caisse</h6>
        </div>

        <div class="caisse-container">
            <!-- Loading State -->
            <div *ngIf="isLoadingCaisses" class="loading-indicator">
                <i class="ri-loader-4-line spin"></i> Chargement des caisses...
            </div>

            <!-- Empty State -->
            <div *ngIf="!isLoadingCaisses && caisses.length === 0" class="no-caisses">
                <i class="ri-information-line"></i>
                <!-- <p>{{ errorMessage || 'Aucune caisse disponible pour cette boutique' }}</p> -->
                <p *ngIf="errorMessage">{{ errorMessage }}</p>
            </div>

            <!-- Liste des caisses -->
            <div *ngFor="let caisse of caisses" class="caisse-card">
                <div class="block">
                    <div class="double" style="align-items: baseline;">
                        <div class="profil">
                            <span>{{ caisse.nomVendeur ? caisse.nomVendeur[0] : '?' }}</span>
                        </div>
                        <div class="caisse-info">
                            <div class="caisse-nom">{{ caisse.nomVendeur || 'Non assigné' }}</div>
                            <div class="caisse-status" 
                                [class.open]="caisse.statut === 'OUVERTE'"
                                [class.closed]="caisse.statut === 'FERMEE'">
                                {{ getStatusText(caisse) }}
                            </div>
                        </div>
                    </div>

                    <!-- zone "more" cliquable -->
                    <div class="icon_more" (click)="toggleMenu(caisse.id)">
                        <i class="ri-more-2-fill"></i>
                        <!-- dropdown -->
                        <div 
                            class="dropdown-menu" 
                            *ngIf="openMenuId === caisse.id"
                            (click)="$event.stopPropagation()">
                           <button (click)="goToPosJournalCaisse()">Journal des caisses</button>
                            <!-- <button (click)="allCaisseClose(caisse)">Autres</button> -->
                        </div>
                    </div>
                </div>
                
               <div class="caisse-container-bottom">
                    <button class="caisse-btn" (click)="onCaisseButtonClick(caisse)">
                        {{ getButtonText(caisse) }}
                    </button>

                    <div class="boutique-name" style="display: flex; align-items: center; gap: 5px;">
                        <div><i class="ri-store-2-line"></i></div>
                        <span>{{ getNomBoutique(caisse) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- // All caisse  -->
        <div class="all_caisse_container" *ngIf="showAllCaissesSection">
            <div class="titre_all_caisse" style="padding: 0 20px;">
                <h6>Toutes les caisses</h6>
            </div>

            <!-- Loading State pour toutes les caisses -->
            <div *ngIf="isLoadingAllCaisses" class="loading-indicator">
                <i class="ri-loader-4-line spin"></i> Chargement des caisses...
            </div>

            <!-- Empty State pour toutes les caisses -->
            <div *ngIf="!isLoadingAllCaisses && allCaisses.length === 0" class="no-caisses">
                <i class="ri-information-line"></i>
                <p>{{ errorMessageAllCaisses || 'Aucune caisse disponible' }}</p>
            </div>

            <div class="all-caisse-container-bottom"  *ngIf="showAllCaissesSection">
                <!-- Boucle sur allCaisses -->
                <div *ngFor="let caisse of allCaisses" class="caisse-card">
                    <div class="block">
                        <div class="double" style="align-items: baseline;">
                            <div class="profil">
                                <span>{{ caisse.nomVendeur ? caisse.nomVendeur[0] : '?' }}</span>
                            </div>
                            <div class="caisse-info">
                                <div class="caisse-nom">{{ caisse.nomVendeur || 'Non assigné' }}</div>
                                <div class="caisse-status" 
                                    [class.open]="caisse.statut === 'OUVERTE'"
                                    [class.closed]="caisse.statut === 'FERMEE'">
                                    {{ getStatusText(caisse) }}
                                </div>
                            </div>
                        </div>

                        <!-- zone "more" cliquable -->
                        <div class="icon_more" (click)="toggleMenu('last_' + caisse.id)">
                            <i class="ri-more-2-fill"></i>
                            <div 
                                class="dropdown-menu" 
                                *ngIf="openMenuId === 'last_' + caisse.id"
                                (click)="$event.stopPropagation()">
                                <button (click)="goToPosJournalCaisse()">Journal des caisses</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="caisse-container-bottom">
                        <!-- <button class="caisse-btn" (click)="onCaisseButtonClick(caisse)" style="cursor: no-drop;">
                            {{ getButtonTextFerme(caisse) }}
                        </button> -->

                        <button class="caisse-btn"
                            [disabled]="caisse.statut === 'FERMEE' || caisse.statut === 'OUVERTE'"
                            [ngClass]="{ 'disabled-like': caisse.statut === 'FERMEE' || caisse.statut === 'OUVERTE' }"
                            [attr.aria-disabled]="(caisse.statut === 'FERMEE' || caisse.statut === 'OUVERTE')"
                            title="{{ (caisse.statut === 'FERMEE' || caisse.statut === 'OUVERTE') ? 'Action non disponible' : '' }}"
                            >
                            {{ getButtonTextFerme(caisse) }}
                        </button>



                        <div class="boutique-name" style="display: flex; align-items: center; gap: 5px;">
                            <div><i class="ri-store-2-line"></i></div>
                            <span>{{ getNomBoutique(caisse) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="showModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Ouvrir une nouvelle caisse</h3>
            <button (click)="closeModal()" class="close-button">
                <i class="ri-close-line"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form (ngSubmit)="submitForm()">
                <div class="form-group">
                    <label>Boutique assignée</label>
                    
                    <!-- Affichage différent selon si une boutique est présélectionnée -->
                    <div *ngIf="selectedBoutiqueId" class="selected-boutique">
                        {{ getBoutiqueName(selectedBoutiqueId) }}
                    </div>
                    
                    <select *ngIf="!selectedBoutiqueId" 
                            [(ngModel)]="selectedBoutiqueId" 
                            name="boutique" 
                            [disabled]="isLoading">
                        <option [value]="null">Sélectionnez une boutique</option>
                        <option *ngFor="let boutique of boutiques" [value]="boutique.id">
                            {{ boutique.nomBoutique }}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Espèces à l'ouverture</label>
                    <input 
                        type="number" 
                        [(ngModel)]="montantOuverture" 
                        name="montant"
                        placeholder="Entrez le montant" 
                        required
                        min="0"
                        step="0.01"
                        [disabled]="isLoading"
                    >
                </div>
                
                <!-- Affichage des erreurs -->
                <div *ngIf="errorMessage" class="error-message">
                    <i class="ri-error-warning-line"></i> 
                    <span [innerHTML]="errorMessage | safeHtml"></span>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button (click)="closeModal()" class="btn-cancel" [disabled]="isLoading">Annuler</button>
            <button (click)="submitForm()" class="btn-submit" [disabled]="isLoading">
                <span *ngIf="!isLoading">Ouvrir la caisse</span>
                <span *ngIf="isLoading" class="loading-spinner"></span>
            </button>
        </div>
    </div>
</div>